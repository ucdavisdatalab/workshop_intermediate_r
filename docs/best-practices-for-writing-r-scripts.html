<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Best Practices for Writing R Scripts | Intermediate R</title>
  <meta name="description" content="3 Best Practices for Writing R Scripts | Intermediate R" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Best Practices for Writing R Scripts | Intermediate R" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="ucdavisdatalab/workshop_intermediate_r" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Best Practices for Writing R Scripts | Intermediate R" />
  
  
  

<meta name="author" content="Nick Ulle and Wesley Brooks" />


<meta name="date" content="2024-02-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="tidy-relational-data.html"/>
<link rel="next" href="squashing-bugs-with-rs-debugging-tools.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://datalab.ucdavis.edu/">
  <img src="https://datalab.ucdavis.edu/wp-content/uploads/2019/07/datalab-logo-full-color-rgb-1.png" style="height: 100%; width: 100%; object-fit: contain" />
</a></li>
<li><a href="./" style="font-size: 18px">Intermediate R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a></li>
<li class="part"><span><b>I Cleaning &amp; Reshaping Data</b></span></li>
<li class="chapter" data-level="1" data-path="string-date-processing.html"><a href="string-date-processing.html"><i class="fa fa-check"></i><b>1</b> String &amp; Date Processing</a>
<ul>
<li class="chapter" data-level="1.1" data-path="string-date-processing.html"><a href="string-date-processing.html#the-tidyverse"><i class="fa fa-check"></i><b>1.1</b> The Tidyverse</a></li>
<li class="chapter" data-level="1.2" data-path="string-date-processing.html"><a href="string-date-processing.html#parsing-dates-times"><i class="fa fa-check"></i><b>1.2</b> Parsing Dates &amp; Times</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="string-date-processing.html"><a href="string-date-processing.html#the-lubridate-package"><i class="fa fa-check"></i><b>1.2.1</b> The lubridate Package</a></li>
<li class="chapter" data-level="1.2.2" data-path="string-date-processing.html"><a href="string-date-processing.html#case-study-ocean-temperatures"><i class="fa fa-check"></i><b>1.2.2</b> Case Study: Ocean Temperatures</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="string-date-processing.html"><a href="string-date-processing.html#string-fundamentals"><i class="fa fa-check"></i><b>1.3</b> String Fundamentals</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="string-date-processing.html"><a href="string-date-processing.html#printing"><i class="fa fa-check"></i><b>1.3.1</b> Printing</a></li>
<li class="chapter" data-level="1.3.2" data-path="string-date-processing.html"><a href="string-date-processing.html#escape-sequences"><i class="fa fa-check"></i><b>1.3.2</b> Escape Sequences</a></li>
<li class="chapter" data-level="1.3.3" data-path="string-date-processing.html"><a href="string-date-processing.html#raw-strings"><i class="fa fa-check"></i><b>1.3.3</b> Raw Strings</a></li>
<li class="chapter" data-level="1.3.4" data-path="string-date-processing.html"><a href="string-date-processing.html#character-encodings"><i class="fa fa-check"></i><b>1.3.4</b> Character Encodings</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="string-date-processing.html"><a href="string-date-processing.html#processing-strings"><i class="fa fa-check"></i><b>1.4</b> Processing Strings</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="string-date-processing.html"><a href="string-date-processing.html#the-stringr-package"><i class="fa fa-check"></i><b>1.4.1</b> The stringr Package</a></li>
<li class="chapter" data-level="1.4.2" data-path="string-date-processing.html"><a href="string-date-processing.html#regular-expressions"><i class="fa fa-check"></i><b>1.4.2</b> Regular Expressions</a></li>
<li class="chapter" data-level="1.4.3" data-path="string-date-processing.html"><a href="string-date-processing.html#replacing-parts-of-strings"><i class="fa fa-check"></i><b>1.4.3</b> Replacing Parts of Strings</a></li>
<li class="chapter" data-level="1.4.4" data-path="string-date-processing.html"><a href="string-date-processing.html#splitting-strings"><i class="fa fa-check"></i><b>1.4.4</b> Splitting Strings</a></li>
<li class="chapter" data-level="1.4.5" data-path="string-date-processing.html"><a href="string-date-processing.html#extracting-matches"><i class="fa fa-check"></i><b>1.4.5</b> Extracting Matches</a></li>
<li class="chapter" data-level="1.4.6" data-path="string-date-processing.html"><a href="string-date-processing.html#case-study-u.s.-warehouse-stocks"><i class="fa fa-check"></i><b>1.4.6</b> Case Study: U.S. Warehouse Stocks</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="string-date-processing.html"><a href="string-date-processing.html#regular-expression-examples"><i class="fa fa-check"></i><b>1.5</b> Regular Expression Examples</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="string-date-processing.html"><a href="string-date-processing.html#the-wildcard"><i class="fa fa-check"></i><b>1.5.1</b> The Wildcard</a></li>
<li class="chapter" data-level="1.5.2" data-path="string-date-processing.html"><a href="string-date-processing.html#escape-sequences-1"><i class="fa fa-check"></i><b>1.5.2</b> Escape Sequences</a></li>
<li class="chapter" data-level="1.5.3" data-path="string-date-processing.html"><a href="string-date-processing.html#anchors"><i class="fa fa-check"></i><b>1.5.3</b> Anchors</a></li>
<li class="chapter" data-level="1.5.4" data-path="string-date-processing.html"><a href="string-date-processing.html#character-classes"><i class="fa fa-check"></i><b>1.5.4</b> Character Classes</a></li>
<li class="chapter" data-level="1.5.5" data-path="string-date-processing.html"><a href="string-date-processing.html#quantifiers"><i class="fa fa-check"></i><b>1.5.5</b> Quantifiers</a></li>
<li class="chapter" data-level="1.5.6" data-path="string-date-processing.html"><a href="string-date-processing.html#groups"><i class="fa fa-check"></i><b>1.5.6</b> Groups</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html"><i class="fa fa-check"></i><b>2</b> Tidy &amp; Relational Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#tidy-datasets"><i class="fa fa-check"></i><b>2.1</b> Tidy Datasets</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#the-tidyr-package"><i class="fa fa-check"></i><b>2.1.1</b> The tidyr Package</a></li>
<li class="chapter" data-level="2.1.2" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#rows-into-columns"><i class="fa fa-check"></i><b>2.1.2</b> Rows into Columns</a></li>
<li class="chapter" data-level="2.1.3" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#columns-into-rows"><i class="fa fa-check"></i><b>2.1.3</b> Columns into Rows</a></li>
<li class="chapter" data-level="2.1.4" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#separating-values"><i class="fa fa-check"></i><b>2.1.4</b> Separating Values</a></li>
<li class="chapter" data-level="2.1.5" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#case-study-smart-ridership"><i class="fa fa-check"></i><b>2.1.5</b> Case Study: SMART Ridership</a></li>
<li class="chapter" data-level="2.1.6" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#without-tidyr"><i class="fa fa-check"></i><b>2.1.6</b> Without <code>tidyr</code></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#relational-datasets"><i class="fa fa-check"></i><b>2.2</b> Relational Datasets</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#the-dplyr-package"><i class="fa fa-check"></i><b>2.2.1</b> The dplyr Package</a></li>
<li class="chapter" data-level="2.2.2" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#gradebook-dataset"><i class="fa fa-check"></i><b>2.2.2</b> Gradebook Dataset</a></li>
<li class="chapter" data-level="2.2.3" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#left-joins"><i class="fa fa-check"></i><b>2.2.3</b> Left Joins</a></li>
<li class="chapter" data-level="2.2.4" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#other-joins"><i class="fa fa-check"></i><b>2.2.4</b> Other Joins</a></li>
<li class="chapter" data-level="2.2.5" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#getting-clever-with-join_by"><i class="fa fa-check"></i><b>2.2.5</b> Getting Clever with <code>join_by</code></a></li>
<li class="chapter" data-level="2.2.6" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#examples"><i class="fa fa-check"></i><b>2.2.6</b> Examples</a></li>
<li class="chapter" data-level="2.2.7" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#be-explicit"><i class="fa fa-check"></i><b>2.2.7</b> Be Explicit</a></li>
<li class="chapter" data-level="2.2.8" data-path="tidy-relational-data.html"><a href="tidy-relational-data.html#conclusion"><i class="fa fa-check"></i><b>2.2.8</b> Conclusion</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Writing &amp; Debugging R Code</b></span></li>
<li class="chapter" data-level="3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html"><i class="fa fa-check"></i><b>3</b> Best Practices for Writing R Scripts</a>
<ul>
<li class="chapter" data-level="3.1" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#case-study-us-fruit-prices"><i class="fa fa-check"></i><b>3.2</b> Case Study: U.S. Fruit Prices</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#setting-up-the-project"><i class="fa fa-check"></i><b>3.2.1</b> Setting Up the Project</a></li>
<li class="chapter" data-level="3.2.2" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#setting-up-the-script"><i class="fa fa-check"></i><b>3.2.2</b> Setting Up the Script</a></li>
<li class="chapter" data-level="3.2.3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#reading-the-pear-data"><i class="fa fa-check"></i><b>3.2.3</b> Reading the Pear Data</a></li>
<li class="chapter" data-level="3.2.4" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#getting-the-fruit-name"><i class="fa fa-check"></i><b>3.2.4</b> Getting the Fruit Name</a></li>
<li class="chapter" data-level="3.2.5" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#getting-the-column-names"><i class="fa fa-check"></i><b>3.2.5</b> Getting the Column Names</a></li>
<li class="chapter" data-level="3.2.6" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#getting-the-price-data"><i class="fa fa-check"></i><b>3.2.6</b> Getting the Price Data</a></li>
<li class="chapter" data-level="3.2.7" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#testing-the-script"><i class="fa fa-check"></i><b>3.2.7</b> Testing the Script</a></li>
<li class="chapter" data-level="3.2.8" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#iterating-over-all-fruit"><i class="fa fa-check"></i><b>3.2.8</b> Iterating Over All Fruit</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#managing-environments"><i class="fa fa-check"></i><b>3.3</b> Managing Environments</a></li>
<li class="chapter" data-level="3.4" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#iteration-strategies"><i class="fa fa-check"></i><b>3.4</b> Iteration Strategies</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#for-loops"><i class="fa fa-check"></i><b>3.4.1</b> For-loops</a></li>
<li class="chapter" data-level="3.4.2" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#while-loops"><i class="fa fa-check"></i><b>3.4.2</b> While-loops</a></li>
<li class="chapter" data-level="3.4.3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#saving-multiple-results"><i class="fa fa-check"></i><b>3.4.3</b> Saving Multiple Results</a></li>
<li class="chapter" data-level="3.4.4" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#break-next"><i class="fa fa-check"></i><b>3.4.4</b> Break &amp; Next</a></li>
<li class="chapter" data-level="3.4.5" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#planning-for-iteration"><i class="fa fa-check"></i><b>3.4.5</b> Planning for Iteration</a></li>
<li class="chapter" data-level="3.4.6" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#case-study-the-collatz-conjecture"><i class="fa fa-check"></i><b>3.4.6</b> Case Study: The Collatz Conjecture</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#printing-output"><i class="fa fa-check"></i><b>3.5</b> Printing Output</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#the-print-function"><i class="fa fa-check"></i><b>3.5.1</b> The <code>print</code> Function</a></li>
<li class="chapter" data-level="3.5.2" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#the-message-function"><i class="fa fa-check"></i><b>3.5.2</b> The <code>message</code> Function</a></li>
<li class="chapter" data-level="3.5.3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#the-cat-function"><i class="fa fa-check"></i><b>3.5.3</b> The <code>cat</code> Function</a></li>
<li class="chapter" data-level="3.5.4" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#formatting-output"><i class="fa fa-check"></i><b>3.5.4</b> Formatting Output</a></li>
<li class="chapter" data-level="3.5.5" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#logging-output"><i class="fa fa-check"></i><b>3.5.5</b> Logging Output</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#reading-input"><i class="fa fa-check"></i><b>3.6</b> Reading Input</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#command-line-arguments"><i class="fa fa-check"></i><b>3.6.1</b> Command Line Arguments</a></li>
<li class="chapter" data-level="3.6.2" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#configuration-files"><i class="fa fa-check"></i><b>3.6.2</b> Configuration Files</a></li>
<li class="chapter" data-level="3.6.3" data-path="best-practices-for-writing-r-scripts.html"><a href="best-practices-for-writing-r-scripts.html#prompts"><i class="fa fa-check"></i><b>3.6.3</b> Prompts</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html"><i class="fa fa-check"></i><b>4</b> Squashing Bugs with R’s Debugging Tools</a>
<ul>
<li class="chapter" data-level="4.1" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#printing-1"><i class="fa fa-check"></i><b>4.1</b> Printing</a></li>
<li class="chapter" data-level="4.2" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#the-conditions-system"><i class="fa fa-check"></i><b>4.2</b> The Conditions System</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#raising-conditions"><i class="fa fa-check"></i><b>4.2.1</b> Raising Conditions</a></li>
<li class="chapter" data-level="4.2.2" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#handling-conditions"><i class="fa fa-check"></i><b>4.2.2</b> Handling Conditions</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#global-options"><i class="fa fa-check"></i><b>4.3</b> Global Options</a></li>
<li class="chapter" data-level="4.4" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#debugging"><i class="fa fa-check"></i><b>4.4</b> Debugging</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#read-your-errors-and-warnings"><i class="fa fa-check"></i><b>4.4.1</b> Read Your Errors and Warnings</a></li>
<li class="chapter" data-level="4.4.2" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#workflow-debugging"><i class="fa fa-check"></i><b>4.4.2</b> Workflow Debugging</a></li>
<li class="chapter" data-level="4.4.3" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#isolate-the-problem"><i class="fa fa-check"></i><b>4.4.3</b> Isolate the Problem</a></li>
<li class="chapter" data-level="4.4.4" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#functions-for-debugging"><i class="fa fa-check"></i><b>4.4.4</b> Functions for debugging</a></li>
<li class="chapter" data-level="4.4.5" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#other-functions"><i class="fa fa-check"></i><b>4.4.5</b> Other Functions</a></li>
<li class="chapter" data-level="4.4.6" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#debugging-case-study-bootstrapping-average-penguin-mass"><i class="fa fa-check"></i><b>4.4.6</b> Debugging Case Study: Bootstrapping Average Penguin Mass</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#measuring-performance"><i class="fa fa-check"></i><b>4.5</b> Measuring Performance</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#estimating-memory-usage"><i class="fa fa-check"></i><b>4.5.1</b> Estimating Memory Usage</a></li>
<li class="chapter" data-level="4.5.2" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#benchmarking"><i class="fa fa-check"></i><b>4.5.2</b> Benchmarking</a></li>
<li class="chapter" data-level="4.5.3" data-path="squashing-bugs-with-rs-debugging-tools.html"><a href="squashing-bugs-with-rs-debugging-tools.html#profiling"><i class="fa fa-check"></i><b>4.5.3</b> Profiling</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Data Visualization &amp; Analysis in R</b></span></li>
<li class="chapter" data-level="5" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html"><i class="fa fa-check"></i><b>5</b> Data Visualization in R</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#our-friend-ggplot2"><i class="fa fa-check"></i><b>5.1</b> Our Friend <code>ggplot2</code></a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#the-grammar-of-graphics"><i class="fa fa-check"></i><b>5.1.1</b> The Grammar of Graphics</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#example-palmer-penguins"><i class="fa fa-check"></i><b>5.2</b> Example: Palmer Penguins</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#examining-the-plot"><i class="fa fa-check"></i><b>5.2.1</b> Examining the Plot</a></li>
<li class="chapter" data-level="5.2.2" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#duplicating-the-palmer-penguins-plot"><i class="fa fa-check"></i><b>5.2.2</b> Duplicating the Palmer Penguins Plot</a></li>
<li class="chapter" data-level="5.2.3" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#analysis"><i class="fa fa-check"></i><b>5.2.3</b> Analysis</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#layers"><i class="fa fa-check"></i><b>5.3</b> Layers</a></li>
<li class="chapter" data-level="5.4" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#guidelines-for-graphics"><i class="fa fa-check"></i><b>5.4</b> Guidelines for Graphics</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#data"><i class="fa fa-check"></i><b>5.4.1</b> Data</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#feature-types"><i class="fa fa-check"></i><b>5.4.2</b> Feature Types</a></li>
<li class="chapter" data-level="5.4.3" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#theme-guidelines"><i class="fa fa-check"></i><b>5.4.3</b> Theme Guidelines</a></li>
<li class="chapter" data-level="5.4.4" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#scale-guidelines"><i class="fa fa-check"></i><b>5.4.4</b> Scale Guidelines</a></li>
<li class="chapter" data-level="5.4.5" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#facet-guidelines"><i class="fa fa-check"></i><b>5.4.5</b> Facet Guidelines</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#case-studies"><i class="fa fa-check"></i><b>5.5</b> Case Studies</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#counting-penguins"><i class="fa fa-check"></i><b>5.5.1</b> Counting Penguins</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#experimental-data-with-error-bars"><i class="fa fa-check"></i><b>5.5.2</b> Experimental Data with Error Bars</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#bird-flu-mortality"><i class="fa fa-check"></i><b>5.5.3</b> Bird Flu Mortality</a></li>
<li class="chapter" data-level="5.5.4" data-path="data-visualization-in-r.html"><a href="data-visualization-in-r.html#small-business-loans"><i class="fa fa-check"></i><b>5.5.4</b> Small Business Loans</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Thinking in R</b></span></li>
<li class="chapter" data-level="6" data-path="language-fundamentals.html"><a href="language-fundamentals.html"><i class="fa fa-check"></i><b>6</b> Language Fundamentals</a>
<ul>
<li class="chapter" data-level="6.1" data-path="language-fundamentals.html"><a href="language-fundamentals.html#variables-environments"><i class="fa fa-check"></i><b>6.1</b> Variables &amp; Environments</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="language-fundamentals.html"><a href="language-fundamentals.html#whats-an-environment"><i class="fa fa-check"></i><b>6.1.1</b> What’s an Environment?</a></li>
<li class="chapter" data-level="6.1.2" data-path="language-fundamentals.html"><a href="language-fundamentals.html#reference-objects"><i class="fa fa-check"></i><b>6.1.2</b> Reference Objects</a></li>
<li class="chapter" data-level="6.1.3" data-path="language-fundamentals.html"><a href="language-fundamentals.html#the-local-environment"><i class="fa fa-check"></i><b>6.1.3</b> The Local Environment</a></li>
<li class="chapter" data-level="6.1.4" data-path="language-fundamentals.html"><a href="language-fundamentals.html#call-environments"><i class="fa fa-check"></i><b>6.1.4</b> Call Environments</a></li>
<li class="chapter" data-level="6.1.5" data-path="language-fundamentals.html"><a href="language-fundamentals.html#lexical-scoping"><i class="fa fa-check"></i><b>6.1.5</b> Lexical Scoping</a></li>
<li class="chapter" data-level="6.1.6" data-path="language-fundamentals.html"><a href="language-fundamentals.html#variable-lookup"><i class="fa fa-check"></i><b>6.1.6</b> Variable Lookup</a></li>
<li class="chapter" data-level="6.1.7" data-path="language-fundamentals.html"><a href="language-fundamentals.html#the-search-path"><i class="fa fa-check"></i><b>6.1.7</b> The Search Path</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="language-fundamentals.html"><a href="language-fundamentals.html#closures"><i class="fa fa-check"></i><b>6.2</b> Closures</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="language-fundamentals.html"><a href="language-fundamentals.html#tidy-closures"><i class="fa fa-check"></i><b>6.2.1</b> Tidy Closures</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="language-fundamentals.html"><a href="language-fundamentals.html#attributes"><i class="fa fa-check"></i><b>6.3</b> Attributes</a></li>
<li class="chapter" data-level="6.4" data-path="language-fundamentals.html"><a href="language-fundamentals.html#s3"><i class="fa fa-check"></i><b>6.4</b> S3</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="language-fundamentals.html"><a href="language-fundamentals.html#method-dispatch"><i class="fa fa-check"></i><b>6.4.1</b> Method Dispatch</a></li>
<li class="chapter" data-level="6.4.2" data-path="language-fundamentals.html"><a href="language-fundamentals.html#creating-objects"><i class="fa fa-check"></i><b>6.4.2</b> Creating Objects</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="language-fundamentals.html"><a href="language-fundamentals.html#other-object-systems"><i class="fa fa-check"></i><b>6.5</b> Other Object Systems</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="part-2.html"><a href="part-2.html"><i class="fa fa-check"></i><b>7</b> Part 2</a></li>
<li class="part"><span><b>V Backmatter</b></span></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="assessment.html"><a href="assessment.html"><i class="fa fa-check"></i>Assessment</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Intermediate R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="best-practices-for-writing-r-scripts" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Best Practices for Writing R Scripts<a href="best-practices-for-writing-r-scripts.html#best-practices-for-writing-r-scripts" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter is all about R scripts: what they are, when to use them, and how
to write them—with specific emphasis making sure your scripts are easy to
read, extend, debug, and reuse. Topics covered along the way include package
management, how to use iteration, how to print or log output, and how to read
input from the command line or from configuration files.</p>
<div id="learning-objectives-2" class="section level4 unnumbered hasAnchor">
<h4>Learning Objectives<a href="best-practices-for-writing-r-scripts.html#learning-objectives-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>After completing this session, learners should be able to:</p>
<ul>
<li>Describe the advantages and disadvantages of using scripts</li>
<li>Develop modular scripts that serve as applications and libraries</li>
<li>Inspect and manage R’s software (package) environment</li>
<li>Describe and use R’s for, while, and repeat loops</li>
<li>Identify the most appropriate iteration strategy for a given task</li>
<li>Explain strategies to organize iterative code</li>
<li>Identify and explain the difference between R’s various printing functions</li>
<li>Read user input from the command line into R</li>
<li>Read data from configuration files into R</li>
</ul>
</div>
<div id="introduction" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Introduction<a href="best-practices-for-writing-r-scripts.html#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>An <strong>R script</strong> is a text file that contains R code. R scripts usually have the
extension <code>.R</code>. You might already use R scripts in your workflow (for example,
if you learned R from DataLab’s <a href="https://ucdavisdatalab.github.io/workshop_r_basics/getting-started.html#r-scripts">R Basics Workshop Series</a>).
Even if you do, this chapter covers many different practices you can adopt to
use scripts more effectively. Although the chapter is focused on R, many of the
practices also apply to scripting other languages.</p>
<p>Notebooks, which usually have the extension <code>.Rmd</code>, are the main alternative to
scripts. Scripts and notebooks are both great ways to store code, and for most
projects, DataLab staff use a mix of both. To decide which one to use, think
about why you’re writing code. Compared to notebooks, the specific advantages
of scripts are that they are:</p>
<ul>
<li><p>Simple. Scripts are text files and usually only contain one programming
language (in our case, R). Notebooks require familiarity with Markdown, and
some also require special software.</p></li>
<li><p>Easy to reuse. In R, you can run all of the code in a script with the
<code>source</code> function. This makes scripts a great way to create a <strong>library</strong> of
reusable functions. Writing reusable scripts is also the first step towards
developing packages to share with a wider audience.</p></li>
<li><p>Easy to run in a command-line interface. R provides a command-line program,
<code>Rscript</code>, for running R scripts. Although you probably use a graphical
interface to run code on your computer, high-performance computing
environments do not always have a graphical interface, and even when they do,
the default is usually a command-line interface. Running notebooks at the
command-line is more difficult.</p></li>
</ul>
<p>Scripts also have one big disadvantage compared to notebooks: results must be
saved and viewed after the script runs, which means you have to plan ahead and
write some extra code. As a result, we recommend scripts for code you plan to
reuse or run at the command-line (especially if it will take a long time to
run), and recommend notebooks for exploratory work. You can read more about how
to decide in DataLab’s <a href="https://ucdavisdatalab.github.io/workshop_reproducible_research/chapters/02_core.html#project-organization">Reproducibility Principles and Practices
reader</a>.</p>
<p>This chapter is organized around a single case study (Section
<a href="best-practices-for-writing-r-scripts.html#case-study-us-fruit-prices">3.2</a>) that benefits from many of the practices we
recommend. At a few points, the narrative branches off from the case study to
take a closer look at a particular practice or topic in more general terms.</p>
</div>
<div id="case-study-us-fruit-prices" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Case Study: U.S. Fruit Prices<a href="best-practices-for-writing-r-scripts.html#case-study-us-fruit-prices" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The U.S. Department of Agriculture (USDA) Economic Research Service (ERS)
computed <a href="https://www.ers.usda.gov/data-products/fruit-and-vegetable-prices/">national average retail prices for various fruits and vegetables in
2013, 2016, and most recently, 2020</a>. These data provide
partial insight into how much Americans must spend to eat a healthy diet with a
variety of fruits and vegetables. The USDA ERS warns against using the data to
compare prices across years because of differences in how products were
categorized, but it can still be used to examine consumer costs in a given
year.</p>
<p>The 2020 data are provided as per-fruit Microsoft Excel (<code>.xlsx</code>) files or as
an all-fruits comma-separated value (CSV) file ready to use with languages such
as R. Unfortunately, the 2016 and 2013 data were only distributed as per-fruit
files, and the structure of these files makes extracting the data non-trivial.</p>
<p>The goal of this case study is to develop an R script that can read the 2016
fruit data into a single all-fruit data frame. We’ll write the script in a way
that makes it easy to extend to the 2016 vegetable data or the 2013 data.</p>
<div id="setting-up-the-project" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Setting Up the Project<a href="best-practices-for-writing-r-scripts.html#setting-up-the-project" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are a few things you should do every time you start working on a new
project. First, create a new directory to store files related to the project.
This is usually called a <strong>repository</strong> or project directory. Give the
repository a descriptive name such as <code>usda_fruit_prices</code>.</p>
<p>The purpose of the repository is to keep files related to the project together,
so that they’re easy to find and share. Choosing a descriptive name for the
repository, and for files in general, will make it easier for others and future
you to understand your work. You can read more about how to <a href="https://ucdavisdatalab.github.io/workshop_reproducible_research/chapters/02_core.html#establish-a-directory-structure">organize
projects</a> and <a href="https://ucdavisdatalab.github.io/workshop_reproducible_research/chapters/02_core.html#use-naming-conventions">choose names</a> in DataLab’s
Reproducibility Principles and Practices reader.</p>
<p>Next, create a <code>data/</code> subdirectory in the repository to store data.
Subdirectories are a good way to keep repositories organized, especially if you
follow a naming convention. For instance, DataLab projects almost always have a
<code>data/</code> subdirectory to store data.</p>
<p>Download the <a href="https://www.ers.usda.gov/webdocs/DataFiles/51035/fruit%202016.zip?v=4034.5">zipped 2016 fruit data</a> and save it in the <code>data/</code>
subdirectory. Unzip the file with a zip program or R’s own <code>unzip</code> function.
Although the 2016 data include CSV files, these have the same structural
problems as the Excel files, so we’ll focus on the Excel files.</p>
<p>Finally, create an <code>R/</code> subdirectory in the repository to store the project’s R
scripts, and make a new R script in subdirectory called <code>extract_prices.R</code>. You
can create and open the script with RStudio or your favorite text editor.</p>
</div>
<div id="setting-up-the-script" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Setting Up the Script<a href="best-practices-for-writing-r-scripts.html#setting-up-the-script" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Start every script with a few comments about its purpose, usage, inputs, and
outputs. These comments will serve as a blueprint for your code and as
documentation. Write them <em>before</em> you write any code—this will help you make
your ideas more concrete and keep you focused when you do start writing code.</p>
<p>For <code>extract_prices.R</code>, the goal is to extract price data from the Excel file
for each fruit (or vegetable). We can extract the data to a data frame, since
the data are already in a tabular format. We can have the script save the data
frame as an RDS file, R’s native data format. If we want to do analysis on the
data, we can use a separate script that reads the RDS file. This is a
<strong>separation of concerns</strong> which ensures we can focus on the task at
hand—data extraction. Summarize these ideas in comments at the beginning of
<code>extract_prices.R</code>, by adding something like this:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="best-practices-for-writing-r-scripts.html#cb247-1" tabindex="-1"></a><span class="co"># Extract a data frame of prices from USDA ERS fruit (and vegetable) price data</span></span>
<span id="cb247-2"><a href="best-practices-for-writing-r-scripts.html#cb247-2" tabindex="-1"></a><span class="co"># Excel files. Save the data frame as an RDS file.</span></span></code></pre></div>
<p>The key to making scripts reusable is to break computational tasks into small
steps and write a short function for each step. When another script (or
project) involves a similar step, you can reuse or repurpose some of the
functions. This function-focused, <strong>modular</strong> development strategy also makes
it easier to find and fix bugs, since you can test each function on a variety
of inputs to make sure it works as intended. The strategy may also help you
tackle large and complex tasks, since the component steps should be smaller and
simpler, and solving one provides positive feedback. Knowing what it means for
a step to be “small” takes experience, but it’s usually better to err on the
side of too small rather than too large. As a rule of thumb, a function with
more than one screen of code is probably trying to do too much.</p>
<p>Scripts you plan to run, like <code>extract_prices.R</code>, need some kind of starting
point. Since we’re taking a function-focused approach, the starting point will
be a function. There’s no standard or conventional name for a starting point
function in R. Many other languages use a function called <code>main</code> as the
starting point, so we’ll copy that convention. Add a function called
<code>main</code> to <code>extract_prices.R</code>:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="best-practices-for-writing-r-scripts.html#cb248-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb248-2"><a href="best-practices-for-writing-r-scripts.html#cb248-2" tabindex="-1"></a>  <span class="co"># We&#39;ll fill this in soon!</span></span>
<span id="cb248-3"><a href="best-practices-for-writing-r-scripts.html#cb248-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Now let’s think about the steps we need to take to extract the price data. We
want to extract the data from many different Excel files. If you haven’t
already, open a few of the files up in a spreadsheet program to take a look at
the data. The first sheet of each file contains a table with the name of the
fruit and prices sorted by how the fruit was prepared. The number of rows
differs between fruits, but the overall structure doesn’t seem to change, which
suggests we can read and process each file in the same way. There are two
things you should do when you encounter a repetitive task like this one:</p>
<ol style="list-style-type: decimal">
<li><p>Start by focusing on a single case. We’ll start by focusing exclusively on
extracting the data for pears (<code>pears 2016.xlsx</code>).</p></li>
<li><p>Once you get the code working on a single case, test that the code is
general enough to handle other cases, and then use iteration to run the code
on all cases. You’ll learn more about iteration later in this case study and
in Section <a href="best-practices-for-writing-r-scripts.html#iteration-strategies">3.4</a>.</p></li>
</ol>
</div>
<div id="reading-the-pear-data" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Reading the Pear Data<a href="best-practices-for-writing-r-scripts.html#reading-the-pear-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first step to extracting the pear data is reading the <code>pears 2016.xlsx</code>
Excel file into R. We’ll use the <code>read_excel</code> function from the <a href="https://readxl.tidyverse.org/">readxl</a>
package to read the files, since R does not provide a built-in function to read
Excel files. Use the R prompt to install the package:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="best-practices-for-writing-r-scripts.html#cb249-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;readxl&quot;</span>)</span></code></pre></div>
<p><em>Do not</em> add this code to the <code>extract_prices.R</code> script. In most cases, you
should not include code to install packages in your scripts. Instead, put
<code>library</code> calls and comments near the beginning of the script, to specify which
packages are required, and leave it to the user to install them. This prevents
needless, time-consuming reinstallation of packages.</p>
<p>We’re going to use the readxl package, so add a <code>library</code> call for the package
near the beginning of <code>extract_prices.R</code>, just after the purpose comments and
just before the <code>main</code> function:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="best-practices-for-writing-r-scripts.html#cb250-1" tabindex="-1"></a><span class="co"># Extract a data frame of prices from USDA ERS fruit (and vegetable) price data</span></span>
<span id="cb250-2"><a href="best-practices-for-writing-r-scripts.html#cb250-2" tabindex="-1"></a><span class="co"># Excel files. Save the data frame as an RDS file.</span></span>
<span id="cb250-3"><a href="best-practices-for-writing-r-scripts.html#cb250-3" tabindex="-1"></a></span>
<span id="cb250-4"><a href="best-practices-for-writing-r-scripts.html#cb250-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb250-5"><a href="best-practices-for-writing-r-scripts.html#cb250-5" tabindex="-1"></a></span>
<span id="cb250-6"><a href="best-practices-for-writing-r-scripts.html#cb250-6" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
<p>We’ll add more calls to <code>library</code> here as we decide to use more packages. This
way it’s easy for someone to see which packages are required as soon as they
open the script. Putting the calls to <code>library</code> in alphabetical order by
package name is also a good idea. You can read more about how to manage the
packages a script or project requires in Section <a href="best-practices-for-writing-r-scripts.html#managing-environments">3.3</a>.</p>
<p>When developing a script, it’s often helpful to run the code, check what’s
working, and make changes, repeating this process until the script is finished.
Fortunately, R provides a convenient way to run an entire script: the <code>source</code>
function. The first argument is the path to the script you want to run. In your
R prompt, try sourcing <code>extract_prices.R</code>:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="best-practices-for-writing-r-scripts.html#cb251-1" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;R/extract_prices.R&quot;</span>)</span></code></pre></div>
<p>The path is relative to R’s working directory; see <a href="https://ucdavisdatalab.github.io/workshop_r_basics/getting-started.html#file-systems">this
section</a> of DataLab’s R Basics reader for details about
how to change the working directory. The code above assumes the repository is
the working directory. If the script was sourced correctly, R will load the
readxl package and define a function <code>main</code>, which currently does nothing. As
you add code to <code>main</code> and add other functions, you can source the script again
to update these functions in your R session. If you’re using R Studio, you can
also check the “source on save” box in the graphical user interface to make R
automatically call <code>source</code> every time you save the script. The <code>source</code>
function can save you time during development, but of course it’s also okay to
run code by typing or pasting it into the prompt.</p>
<p>Take a look at the help file for the <code>read_excel</code> function (run <code>?read_excel</code>
in the R prompt). The first argument is the path to the Excel file to read.
Change the code in the <code>main</code> function to read the pear data:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="best-practices-for-writing-r-scripts.html#cb252-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb252-2"><a href="best-practices-for-writing-r-scripts.html#cb252-2" tabindex="-1"></a>  <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/pears 2016.xlsx&quot;</span>)</span>
<span id="cb252-3"><a href="best-practices-for-writing-r-scripts.html#cb252-3" tabindex="-1"></a></span>
<span id="cb252-4"><a href="best-practices-for-writing-r-scripts.html#cb252-4" tabindex="-1"></a>  <span class="co"># More to come...</span></span>
<span id="cb252-5"><a href="best-practices-for-writing-r-scripts.html#cb252-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Source the script and then call <code>main</code> in the R prompt:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="best-practices-for-writing-r-scripts.html#cb253-1" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<pre><code>## New names:
## • `` -&gt; `...2`
## • `` -&gt; `...3`
## • `` -&gt; `...4`
## • `` -&gt; `...5`
## • `` -&gt; `...6`
## • `` -&gt; `...7`</code></pre>
<pre><code>## # A tibble: 13 × 7
##    Pears—Average retail price per pound an…¹ ...2  ...3  ...4  ...5  ...6  ...7 
##    &lt;chr&gt;                                     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
##  1 Form                                      Aver… &lt;NA&gt;  Prep… Size… &lt;NA&gt;  Aver…
##  2 &lt;NA&gt;                                      &lt;NA&gt;  &lt;NA&gt;  yiel… cup … &lt;NA&gt;  per …
##  3 Fresh1                                    1.51… per … 0.9   0.36… poun… 0.61…
##  4 Canned                                    &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  5 Packed in juice2                          1.78… per … 1     0.54… poun… 0.96…
##  6 Packed in syrup or water3                 1.57… per … 0.65  0.44… poun… 1.06…
##  7 1The USDA National Nutrient Database for… &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  8 &lt;NA&gt;                                      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
##  9 2Consumers are assumed to eat the solid … &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 10 &lt;NA&gt;                                      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 11 3The syrup (or water) is discarded prior… &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 12 &lt;NA&gt;                                      &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 13 Source: Calculated by USDA, Economic Res… &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## # ℹ abbreviated name:
## #   ¹​`Pears—Average retail price per pound and per cup equivalent, 2016`</code></pre>
<p>This returns the data in the Excel file, but there’s still a lot of cleanup to
do. Since we’re eventually going to extract data about many different fruits,
let’s start by getting the name of the fruit from the Excel file.</p>
</div>
<div id="getting-the-fruit-name" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Getting the Fruit Name<a href="best-practices-for-writing-r-scripts.html#getting-the-fruit-name" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Notice that the name of each fruit is in the top left cell (<code>A1</code>) of its file.
The <code>read_excel</code> function treats the first row of cells as headers, so in the
data frame, the name of the fruit is in the first column name. Create a
function called <code>get_fruit_name</code> to get this column name:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="best-practices-for-writing-r-scripts.html#cb256-1" tabindex="-1"></a>get_fruit_name <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb256-2"><a href="best-practices-for-writing-r-scripts.html#cb256-2" tabindex="-1"></a>  <span class="fu">names</span>(sheet)[[<span class="dv">1</span>]]</span>
<span id="cb256-3"><a href="best-practices-for-writing-r-scripts.html#cb256-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Also update the <code>main</code> function to save the data frame in a variable and call
<code>get_fruit_name</code>:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="best-practices-for-writing-r-scripts.html#cb257-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb257-2"><a href="best-practices-for-writing-r-scripts.html#cb257-2" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/pears 2016.xlsx&quot;</span>)</span>
<span id="cb257-3"><a href="best-practices-for-writing-r-scripts.html#cb257-3" tabindex="-1"></a></span>
<span id="cb257-4"><a href="best-practices-for-writing-r-scripts.html#cb257-4" tabindex="-1"></a>  <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb257-5"><a href="best-practices-for-writing-r-scripts.html#cb257-5" tabindex="-1"></a>  <span class="co"># More to come...</span></span>
<span id="cb257-6"><a href="best-practices-for-writing-r-scripts.html#cb257-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Once again, source the script and call <code>main</code>. The return value will be a
string:</p>
<pre><code>## [1] &quot;Pears—Average retail price per pound and per cup equivalent, 2016&quot;</code></pre>
<p>This has the name of the fruit, but also some extra text. To get just the name,
we need to do some string processing. We’ll use the <a href="https://stringr.tidyverse.org/">stringr</a> package for
string processing.</p>
<p>Install the package and add it to the <code>library</code> calls at the
beginning of <code>extract_prices.R</code>:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="best-practices-for-writing-r-scripts.html#cb259-1" tabindex="-1"></a><span class="co"># Extract a data frame of prices from USDA ERS fruit (and vegetable) price data</span></span>
<span id="cb259-2"><a href="best-practices-for-writing-r-scripts.html#cb259-2" tabindex="-1"></a><span class="co"># Excel files. Save the data frame as an RDS file.</span></span>
<span id="cb259-3"><a href="best-practices-for-writing-r-scripts.html#cb259-3" tabindex="-1"></a></span>
<span id="cb259-4"><a href="best-practices-for-writing-r-scripts.html#cb259-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb259-5"><a href="best-practices-for-writing-r-scripts.html#cb259-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;stringr&quot;</span>)</span>
<span id="cb259-6"><a href="best-practices-for-writing-r-scripts.html#cb259-6" tabindex="-1"></a></span>
<span id="cb259-7"><a href="best-practices-for-writing-r-scripts.html#cb259-7" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
<p>We’ll use several functions from stringr, but each will be explained in
context. The package provides detailed documentation as well as a
<a href="https://github.com/rstudio/cheatsheets/blob/master/strings.pdf">cheatsheet</a>. If you want to learn more about string
processing and stringr in general, see Chapter <a href="string-date-processing.html#string-date-processing">1</a> of
this reader.</p>
<p>The name of the fruit is separated from the extra text by an em dash (the <code>—</code>
character, which is longer than minus, the <code>-</code> character). We can use the
<code>str_split_fixed</code> function to split the text into two parts at the em dash. The
function’s first argument is the string to split, its second is the character
on which to split (copy and paste the em dash), and its third is the number of
parts. The function returns a matrix where each column corresponds to one of
the split parts. In <code>extract_prices.R</code>, update <code>get_fruit_name</code> to split the
text and get the first element, the fruit name:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="best-practices-for-writing-r-scripts.html#cb260-1" tabindex="-1"></a>get_fruit_name <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb260-2"><a href="best-practices-for-writing-r-scripts.html#cb260-2" tabindex="-1"></a>  text <span class="ot">=</span> <span class="fu">names</span>(sheet)[[<span class="dv">1</span>]]</span>
<span id="cb260-3"><a href="best-practices-for-writing-r-scripts.html#cb260-3" tabindex="-1"></a>  <span class="fu">str_split_fixed</span>(text, <span class="st">&quot;—&quot;</span>, <span class="dv">2</span>)[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb260-4"><a href="best-practices-for-writing-r-scripts.html#cb260-4" tabindex="-1"></a>}</span></code></pre></div>
<p>As usual, source the script and call <code>main</code>. The result is just the fruit
name:</p>
<pre><code>## [1] &quot;Pears&quot;</code></pre>
<p>We’ll use the fruit name later to label the data from each file.</p>
</div>
<div id="getting-the-column-names" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Getting the Column Names<a href="best-practices-for-writing-r-scripts.html#getting-the-column-names" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The column names on the <code>sheet</code> data frame come from the first row of the file,
but the actual headers of the table are in the second and third rows of the
file (rows 1 and 2 of the data frame):</p>
<pre><code>## # A tibble: 6 × 7
##   Pears—Average retail price per pound and…¹ ...2  ...3  ...4  ...5  ...6  ...7 
##   &lt;chr&gt;                                      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 Form                                       Aver… &lt;NA&gt;  Prep… Size… &lt;NA&gt;  Aver…
## 2 &lt;NA&gt;                                       &lt;NA&gt;  &lt;NA&gt;  yiel… cup … &lt;NA&gt;  per …
## 3 Fresh1                                     1.51… per … 0.9   0.36… poun… 0.61…
## 4 Canned                                     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## 5 Packed in juice2                           1.78… per … 1     0.54… poun… 0.96…
## 6 Packed in syrup or water3                  1.57… per … 0.65  0.44… poun… 1.06…
## # ℹ abbreviated name:
## #   ¹​`Pears—Average retail price per pound and per cup equivalent, 2016`</code></pre>
<p>Let’s create another function, <code>get_column_names</code>, to convert these rows into a
vector we can use as column names. Add the function to <code>extract_prices.R</code>, with
a code to get rows 1 and 2 of the data frame:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="best-practices-for-writing-r-scripts.html#cb263-1" tabindex="-1"></a>get_column_names <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb263-2"><a href="best-practices-for-writing-r-scripts.html#cb263-2" tabindex="-1"></a>  <span class="co"># Get rows 1 and 2, all columns.</span></span>
<span id="cb263-3"><a href="best-practices-for-writing-r-scripts.html#cb263-3" tabindex="-1"></a>  sheet[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, ]</span>
<span id="cb263-4"><a href="best-practices-for-writing-r-scripts.html#cb263-4" tabindex="-1"></a>}</span></code></pre></div>
<p>As usual, update <code>main</code> to call the new function:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="best-practices-for-writing-r-scripts.html#cb264-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb264-2"><a href="best-practices-for-writing-r-scripts.html#cb264-2" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/pears 2016.xlsx&quot;</span>)</span>
<span id="cb264-3"><a href="best-practices-for-writing-r-scripts.html#cb264-3" tabindex="-1"></a></span>
<span id="cb264-4"><a href="best-practices-for-writing-r-scripts.html#cb264-4" tabindex="-1"></a>  fruit <span class="ot">=</span> <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb264-5"><a href="best-practices-for-writing-r-scripts.html#cb264-5" tabindex="-1"></a>  <span class="fu">get_column_names</span>(sheet)</span>
<span id="cb264-6"><a href="best-practices-for-writing-r-scripts.html#cb264-6" tabindex="-1"></a>  <span class="co"># More to come...</span></span>
<span id="cb264-7"><a href="best-practices-for-writing-r-scripts.html#cb264-7" tabindex="-1"></a>}</span></code></pre></div>
<p>Then source <code>extract_prices.R</code> and call <code>main</code>:</p>
<pre><code>## # A tibble: 2 × 7
##   Pears—Average retail price per pound and…¹ ...2  ...3  ...4  ...5  ...6  ...7 
##   &lt;chr&gt;                                      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1 Form                                       Aver… &lt;NA&gt;  Prep… Size… &lt;NA&gt;  Aver…
## 2 &lt;NA&gt;                                       &lt;NA&gt;  &lt;NA&gt;  yiel… cup … &lt;NA&gt;  per …
## # ℹ abbreviated name:
## #   ¹​`Pears—Average retail price per pound and per cup equivalent, 2016`</code></pre>
<p>For each column, we need to paste the rows together. This “for each” is a hint
that the task that can be solved with iteration. Before proceeding, take a
moment to learn more about iteration by reading through Section
<a href="best-practices-for-writing-r-scripts.html#iteration-strategies">3.4</a>. For this task, the result should be one string per
column, so you can use <code>sapply</code> to iterate over the columns.</p>
<p>By setting its <code>collapse</code> argument, you can use R’s built-in <code>paste</code> function
to paste together the elements of a vector together. The value of <code>collapse</code> is
inserted between the elements. For the fruit price headers, there should be a
space between the row text, so we’ll set <code>collapse = " "</code>. In
<code>extract_prices.R</code>, update <code>get_column_names</code>, source the file, and call
<code>main</code>:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="best-practices-for-writing-r-scripts.html#cb266-1" tabindex="-1"></a>get_column_names <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb266-2"><a href="best-practices-for-writing-r-scripts.html#cb266-2" tabindex="-1"></a>  <span class="co"># Get rows 1 and 2, all columns.</span></span>
<span id="cb266-3"><a href="best-practices-for-writing-r-scripts.html#cb266-3" tabindex="-1"></a>  names <span class="ot">=</span> sheet[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, ]</span>
<span id="cb266-4"><a href="best-practices-for-writing-r-scripts.html#cb266-4" tabindex="-1"></a>  <span class="fu">sapply</span>(names, paste, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb266-5"><a href="best-practices-for-writing-r-scripts.html#cb266-5" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Pears—Average retail price per pound and per cup equivalent, 2016 
##                                                         &quot;Form NA&quot; 
##                                                              ...2 
##                                         &quot;Average retail price NA&quot; 
##                                                              ...3 
##                                                           &quot;NA NA&quot; 
##                                                              ...4 
##                                        &quot;Preparation yield factor&quot; 
##                                                              ...5 
##                                        &quot;Size of a cup equivalent&quot; 
##                                                              ...6 
##                                                           &quot;NA NA&quot; 
##                                                              ...7 
##                                &quot;Average price per cup equivalent&quot;</code></pre>
<p>The result is almost right, but the <code>paste</code> function converts all of the
missing values <code>NA</code> to literal text <code>"NA"</code>. To fix this, replace all of the
missing values with the empty string <code>""</code> before pasting the rows together.
Let’s add a call to <code>str_trim</code> at the end of <code>get_column_names</code> to trim off any
excess spaces as well. Once again, update the function in <code>extract_prices.R</code>,
source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="best-practices-for-writing-r-scripts.html#cb268-1" tabindex="-1"></a>get_column_names <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb268-2"><a href="best-practices-for-writing-r-scripts.html#cb268-2" tabindex="-1"></a>  <span class="co"># Get rows 1 and 2, all columns.</span></span>
<span id="cb268-3"><a href="best-practices-for-writing-r-scripts.html#cb268-3" tabindex="-1"></a>  names <span class="ot">=</span> sheet[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, ]</span>
<span id="cb268-4"><a href="best-practices-for-writing-r-scripts.html#cb268-4" tabindex="-1"></a>  <span class="co"># Paste together, treating NAs as empty string.</span></span>
<span id="cb268-5"><a href="best-practices-for-writing-r-scripts.html#cb268-5" tabindex="-1"></a>  names[<span class="fu">is.na</span>(names)] <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb268-6"><a href="best-practices-for-writing-r-scripts.html#cb268-6" tabindex="-1"></a>  names <span class="ot">=</span> <span class="fu">sapply</span>(names, paste, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb268-7"><a href="best-practices-for-writing-r-scripts.html#cb268-7" tabindex="-1"></a>  <span class="co"># Trim off extra whitespace.</span></span>
<span id="cb268-8"><a href="best-practices-for-writing-r-scripts.html#cb268-8" tabindex="-1"></a>  <span class="fu">str_trim</span>(names)</span>
<span id="cb268-9"><a href="best-practices-for-writing-r-scripts.html#cb268-9" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;Form&quot;                             &quot;Average retail price&quot;            
## [3] &quot;&quot;                                 &quot;Preparation yield factor&quot;        
## [5] &quot;Size of a cup equivalent&quot;         &quot;&quot;                                
## [7] &quot;Average price per cup equivalent&quot;</code></pre>
<p>Notice that now two of the elements are just the empty string <code>""</code>. Take a look
at the Excel file. Can you see why this happens? These are the two columns with
units, so let’s call them <code>units1</code> and <code>units2</code>. The numbers are to make the
column names are unique. Let’s also make the other column names easier to use
by converting them to lowercase with <code>str_to_lower</code> and replacing the spaces
with underscores <code>_</code> with <code>str_replace_all</code>. In <code>extract_prices.R</code>, update
<code>get_column_names</code>, source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="best-practices-for-writing-r-scripts.html#cb270-1" tabindex="-1"></a>get_column_names <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb270-2"><a href="best-practices-for-writing-r-scripts.html#cb270-2" tabindex="-1"></a>  <span class="co"># Get rows 1 and 2, all columns.</span></span>
<span id="cb270-3"><a href="best-practices-for-writing-r-scripts.html#cb270-3" tabindex="-1"></a>  names <span class="ot">=</span> sheet[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, ]</span>
<span id="cb270-4"><a href="best-practices-for-writing-r-scripts.html#cb270-4" tabindex="-1"></a>  <span class="co"># Paste together, treating NAs as empty strings.</span></span>
<span id="cb270-5"><a href="best-practices-for-writing-r-scripts.html#cb270-5" tabindex="-1"></a>  names[<span class="fu">is.na</span>(names)] <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb270-6"><a href="best-practices-for-writing-r-scripts.html#cb270-6" tabindex="-1"></a>  names <span class="ot">=</span> <span class="fu">sapply</span>(names, paste, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>)</span>
<span id="cb270-7"><a href="best-practices-for-writing-r-scripts.html#cb270-7" tabindex="-1"></a>  <span class="co"># Trim off extra whitespace.</span></span>
<span id="cb270-8"><a href="best-practices-for-writing-r-scripts.html#cb270-8" tabindex="-1"></a>  names <span class="ot">=</span> <span class="fu">str_trim</span>(names)</span>
<span id="cb270-9"><a href="best-practices-for-writing-r-scripts.html#cb270-9" tabindex="-1"></a></span>
<span id="cb270-10"><a href="best-practices-for-writing-r-scripts.html#cb270-10" tabindex="-1"></a>  <span class="co"># Replace empty names with &quot;unitsN&quot;</span></span>
<span id="cb270-11"><a href="best-practices-for-writing-r-scripts.html#cb270-11" tabindex="-1"></a>  is_empty <span class="ot">=</span> names <span class="sc">==</span> <span class="st">&quot;&quot;</span></span>
<span id="cb270-12"><a href="best-practices-for-writing-r-scripts.html#cb270-12" tabindex="-1"></a>  n_empty <span class="ot">=</span> <span class="fu">sum</span>(is_empty)</span>
<span id="cb270-13"><a href="best-practices-for-writing-r-scripts.html#cb270-13" tabindex="-1"></a>  names[is_empty] <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;units&quot;</span>, <span class="fu">seq_len</span>(n_empty), <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb270-14"><a href="best-practices-for-writing-r-scripts.html#cb270-14" tabindex="-1"></a></span>
<span id="cb270-15"><a href="best-practices-for-writing-r-scripts.html#cb270-15" tabindex="-1"></a>  <span class="co"># Convert to lowercase and replace spaces with underscores.</span></span>
<span id="cb270-16"><a href="best-practices-for-writing-r-scripts.html#cb270-16" tabindex="-1"></a>  names <span class="ot">=</span> <span class="fu">str_to_lower</span>(names)</span>
<span id="cb270-17"><a href="best-practices-for-writing-r-scripts.html#cb270-17" tabindex="-1"></a>  <span class="fu">str_replace_all</span>(names, <span class="st">&quot; +&quot;</span>, <span class="st">&quot;_&quot;</span>)</span>
<span id="cb270-18"><a href="best-practices-for-writing-r-scripts.html#cb270-18" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;form&quot;                             &quot;average_retail_price&quot;            
## [3] &quot;units1&quot;                           &quot;preparation_yield_factor&quot;        
## [5] &quot;size_of_a_cup_equivalent&quot;         &quot;units2&quot;                          
## [7] &quot;average_price_per_cup_equivalent&quot;</code></pre>
<p>These names look good enough to use.</p>
</div>
<div id="getting-the-price-data" class="section level3 hasAnchor" number="3.2.6">
<h3><span class="header-section-number">3.2.6</span> Getting the Price Data<a href="best-practices-for-writing-r-scripts.html#getting-the-price-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>With the fruit name and column names taken care of, now it’s time to get the
actual price data. There are a few different ways to identify the rows with
price data. One way is to look for entries in the second column. Let’s set up a
new function, <code>get_fruit_prices</code>. Eventually we’ll make this function return
the price data, but to get started, let’s make it return the indexes of the
first and last row with entries in the second column. Add this code to
<code>extract_prices.R</code>:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="best-practices-for-writing-r-scripts.html#cb272-1" tabindex="-1"></a>get_fruit_prices <span class="ot">=</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb272-2"><a href="best-practices-for-writing-r-scripts.html#cb272-2" tabindex="-1"></a>  is_filled <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(sheet[, <span class="dv">2</span>])</span>
<span id="cb272-3"><a href="best-practices-for-writing-r-scripts.html#cb272-3" tabindex="-1"></a>  <span class="fu">range</span>(<span class="fu">which</span>(is_filled))</span>
<span id="cb272-4"><a href="best-practices-for-writing-r-scripts.html#cb272-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Then update <code>main</code>, source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="best-practices-for-writing-r-scripts.html#cb273-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb273-2"><a href="best-practices-for-writing-r-scripts.html#cb273-2" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/pears 2016.xlsx&quot;</span>)</span>
<span id="cb273-3"><a href="best-practices-for-writing-r-scripts.html#cb273-3" tabindex="-1"></a></span>
<span id="cb273-4"><a href="best-practices-for-writing-r-scripts.html#cb273-4" tabindex="-1"></a>  fruit <span class="ot">=</span> <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb273-5"><a href="best-practices-for-writing-r-scripts.html#cb273-5" tabindex="-1"></a>  col_names <span class="ot">=</span> <span class="fu">get_column_names</span>(sheet)</span>
<span id="cb273-6"><a href="best-practices-for-writing-r-scripts.html#cb273-6" tabindex="-1"></a></span>
<span id="cb273-7"><a href="best-practices-for-writing-r-scripts.html#cb273-7" tabindex="-1"></a>  <span class="fu">get_fruit_prices</span>(sheet)</span>
<span id="cb273-8"><a href="best-practices-for-writing-r-scripts.html#cb273-8" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1 6</code></pre>
<p>The first index corresponds to the header row, but we already dealt with the
header in Section <a href="best-practices-for-writing-r-scripts.html#getting-the-column-names">3.2.5</a>. Since the header spans two
rows, we can skip it by adding 2 to the first index. The second index
corresponds to the last row of prices, so it seems like this is an effective
strategy for getting the price data (we can’t be completely sure until we test
the strategy on other fruits).</p>
<p>Update <code>get_fruit_prices</code> and <code>main</code> in <code>extract_prices.R</code> to get the subset of
rows with price data and to change the column names to the ones we computed
earlier:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="best-practices-for-writing-r-scripts.html#cb275-1" tabindex="-1"></a>get_fruit_prices <span class="ot">=</span> <span class="cf">function</span>(sheet, col_names) {</span>
<span id="cb275-2"><a href="best-practices-for-writing-r-scripts.html#cb275-2" tabindex="-1"></a>  <span class="co"># Get all rows from first entry to last entry in column 2.</span></span>
<span id="cb275-3"><a href="best-practices-for-writing-r-scripts.html#cb275-3" tabindex="-1"></a>  is_filled <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(sheet[, <span class="dv">2</span>])</span>
<span id="cb275-4"><a href="best-practices-for-writing-r-scripts.html#cb275-4" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">range</span>(<span class="fu">which</span>(is_filled))</span>
<span id="cb275-5"><a href="best-practices-for-writing-r-scripts.html#cb275-5" tabindex="-1"></a>  prices <span class="ot">=</span> sheet[<span class="fu">seq</span>(idx[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">2</span>, idx[<span class="dv">2</span>]), ]</span>
<span id="cb275-6"><a href="best-practices-for-writing-r-scripts.html#cb275-6" tabindex="-1"></a></span>
<span id="cb275-7"><a href="best-practices-for-writing-r-scripts.html#cb275-7" tabindex="-1"></a>  <span class="co"># Set column names.</span></span>
<span id="cb275-8"><a href="best-practices-for-writing-r-scripts.html#cb275-8" tabindex="-1"></a>  <span class="fu">names</span>(prices) <span class="ot">=</span> col_names</span>
<span id="cb275-9"><a href="best-practices-for-writing-r-scripts.html#cb275-9" tabindex="-1"></a></span>
<span id="cb275-10"><a href="best-practices-for-writing-r-scripts.html#cb275-10" tabindex="-1"></a>  prices</span>
<span id="cb275-11"><a href="best-practices-for-writing-r-scripts.html#cb275-11" tabindex="-1"></a>}</span>
<span id="cb275-12"><a href="best-practices-for-writing-r-scripts.html#cb275-12" tabindex="-1"></a></span>
<span id="cb275-13"><a href="best-practices-for-writing-r-scripts.html#cb275-13" tabindex="-1"></a></span>
<span id="cb275-14"><a href="best-practices-for-writing-r-scripts.html#cb275-14" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb275-15"><a href="best-practices-for-writing-r-scripts.html#cb275-15" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/pears 2016.xlsx&quot;</span>)</span>
<span id="cb275-16"><a href="best-practices-for-writing-r-scripts.html#cb275-16" tabindex="-1"></a></span>
<span id="cb275-17"><a href="best-practices-for-writing-r-scripts.html#cb275-17" tabindex="-1"></a>  fruit <span class="ot">=</span> <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb275-18"><a href="best-practices-for-writing-r-scripts.html#cb275-18" tabindex="-1"></a>  col_names <span class="ot">=</span> <span class="fu">get_column_names</span>(sheet)</span>
<span id="cb275-19"><a href="best-practices-for-writing-r-scripts.html#cb275-19" tabindex="-1"></a></span>
<span id="cb275-20"><a href="best-practices-for-writing-r-scripts.html#cb275-20" tabindex="-1"></a>  <span class="fu">get_fruit_prices</span>(sheet, col_names)</span>
<span id="cb275-21"><a href="best-practices-for-writing-r-scripts.html#cb275-21" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## # A tibble: 4 × 7
##   form                      average_retail_price units1   preparation_yield_fa…¹
##   &lt;chr&gt;                     &lt;chr&gt;                &lt;chr&gt;    &lt;chr&gt;                 
## 1 Fresh1                    1.5175920102         per pou… 0.9                   
## 2 Canned                    &lt;NA&gt;                 &lt;NA&gt;     &lt;NA&gt;                  
## 3 Packed in juice2          1.7876110202         per pou… 1                     
## 4 Packed in syrup or water3 1.5716448654999999   per pou… 0.65                  
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>The result looks good, but notice that the <code>"Canned"</code> row has a several missing
values. Take a look at the original Excel file to figure out why this happens.
The <code>"Canned"</code> row is the beginning of a subgroup of prices for canned fruit.
The data frame returned by <code>get_fruit_prices</code> will be more convenient for
analysis if we exclude the <code>"Canned"</code> row and instead mark the following two
rows as canned. For instance, we might label their form as <code>"Canned, packed in juice"</code> and <code>"Canned, packed in syrup or water"</code>.</p>
<p>One way to approach the subgroup labeling task is to compute the subgroup for
each row, then use the <a href="https://ucdavisdatalab.github.io/workshop_r_basics/exploring-data.html#the-split-apply-pattern">split-apply pattern</a> to process each
subgroup. The <code>"Canned"</code> row doesn’t have an entry in the second column, so
maybe we can use that to detect where each subgroup begins. You can use the
<code>is.na</code> to find those rows, and the cumulative sum function <code>cumsum</code> to make
the subgroup labels (since <code>FALSE</code> counts as <code>0</code> and <code>TRUE</code> counts as <code>1</code>).
Update <code>get_fruit_prices</code> in <code>extract_prices.R</code> to split the price data by
subgroup labels, source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="best-practices-for-writing-r-scripts.html#cb277-1" tabindex="-1"></a>get_fruit_prices <span class="ot">=</span> <span class="cf">function</span>(sheet, col_names) {</span>
<span id="cb277-2"><a href="best-practices-for-writing-r-scripts.html#cb277-2" tabindex="-1"></a>  <span class="co"># Get all rows from first entry to last entry in column 2.</span></span>
<span id="cb277-3"><a href="best-practices-for-writing-r-scripts.html#cb277-3" tabindex="-1"></a>  is_filled <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(sheet[, <span class="dv">2</span>])</span>
<span id="cb277-4"><a href="best-practices-for-writing-r-scripts.html#cb277-4" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">range</span>(<span class="fu">which</span>(is_filled))</span>
<span id="cb277-5"><a href="best-practices-for-writing-r-scripts.html#cb277-5" tabindex="-1"></a>  prices <span class="ot">=</span> sheet[<span class="fu">seq</span>(idx[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">2</span>, idx[<span class="dv">2</span>]), ]</span>
<span id="cb277-6"><a href="best-practices-for-writing-r-scripts.html#cb277-6" tabindex="-1"></a></span>
<span id="cb277-7"><a href="best-practices-for-writing-r-scripts.html#cb277-7" tabindex="-1"></a>  <span class="co"># Set column names.</span></span>
<span id="cb277-8"><a href="best-practices-for-writing-r-scripts.html#cb277-8" tabindex="-1"></a>  <span class="fu">names</span>(prices) <span class="ot">=</span> col_names</span>
<span id="cb277-9"><a href="best-practices-for-writing-r-scripts.html#cb277-9" tabindex="-1"></a></span>
<span id="cb277-10"><a href="best-practices-for-writing-r-scripts.html#cb277-10" tabindex="-1"></a>  <span class="co"># Compute form subgroups.</span></span>
<span id="cb277-11"><a href="best-practices-for-writing-r-scripts.html#cb277-11" tabindex="-1"></a>  subgroups <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="fu">is.na</span>(prices[, <span class="dv">2</span>]))</span>
<span id="cb277-12"><a href="best-practices-for-writing-r-scripts.html#cb277-12" tabindex="-1"></a>  <span class="fu">split</span>(prices, subgroups)</span>
<span id="cb277-13"><a href="best-practices-for-writing-r-scripts.html#cb277-13" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## $`0`
## # A tibble: 1 × 7
##   form   average_retail_price units1    preparation_yield_factor
##   &lt;chr&gt;  &lt;chr&gt;                &lt;chr&gt;     &lt;chr&gt;                   
## 1 Fresh1 1.5175920102         per pound 0.9                     
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;
## 
## $`1`
## # A tibble: 3 × 7
##   form                      average_retail_price units1   preparation_yield_fa…¹
##   &lt;chr&gt;                     &lt;chr&gt;                &lt;chr&gt;    &lt;chr&gt;                 
## 1 Canned                    &lt;NA&gt;                 &lt;NA&gt;     &lt;NA&gt;                  
## 2 Packed in juice2          1.7876110202         per pou… 1                     
## 3 Packed in syrup or water3 1.5716448654999999   per pou… 0.65                  
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>The result is a separate data frame for each subgroup. For each subgroup, we
need to check whether the first row has an entry in the second column. If it
doesn’t, then the first row is a group name (like <code>"Canned"</code>) that should be
pasted onto the other rows in the group. Add a function
<code>process_price_subgroup</code> to <code>extract_prices.R</code> to do this for a single group:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="best-practices-for-writing-r-scripts.html#cb279-1" tabindex="-1"></a>process_price_subgroup <span class="ot">=</span> <span class="cf">function</span>(subgroup) {</span>
<span id="cb279-2"><a href="best-practices-for-writing-r-scripts.html#cb279-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(subgroup[<span class="dv">1</span>, <span class="dv">2</span>])) {</span>
<span id="cb279-3"><a href="best-practices-for-writing-r-scripts.html#cb279-3" tabindex="-1"></a>    <span class="co"># First row is group name, so remove the row and paste the group name onto</span></span>
<span id="cb279-4"><a href="best-practices-for-writing-r-scripts.html#cb279-4" tabindex="-1"></a>    <span class="co"># the other rows.</span></span>
<span id="cb279-5"><a href="best-practices-for-writing-r-scripts.html#cb279-5" tabindex="-1"></a>    name <span class="ot">=</span> subgroup[[<span class="dv">1</span>, <span class="dv">1</span>]]</span>
<span id="cb279-6"><a href="best-practices-for-writing-r-scripts.html#cb279-6" tabindex="-1"></a>    subgroup <span class="ot">=</span> subgroup[<span class="sc">-</span><span class="dv">1</span>, ]</span>
<span id="cb279-7"><a href="best-practices-for-writing-r-scripts.html#cb279-7" tabindex="-1"></a>    form <span class="ot">=</span> <span class="fu">str_to_lower</span>(<span class="fu">str_trim</span>(subgroup<span class="sc">$</span>form))</span>
<span id="cb279-8"><a href="best-practices-for-writing-r-scripts.html#cb279-8" tabindex="-1"></a>    subgroup<span class="sc">$</span>form <span class="ot">=</span> <span class="fu">paste</span>(name, form, <span class="at">sep =</span> <span class="st">&quot;, &quot;</span>)</span>
<span id="cb279-9"><a href="best-practices-for-writing-r-scripts.html#cb279-9" tabindex="-1"></a>  }</span>
<span id="cb279-10"><a href="best-practices-for-writing-r-scripts.html#cb279-10" tabindex="-1"></a>  subgroup</span>
<span id="cb279-11"><a href="best-practices-for-writing-r-scripts.html#cb279-11" tabindex="-1"></a>}</span></code></pre></div>
<p>You can use <code>lapply</code> to apply this function to each subgroup, and <code>do.call</code>
with <code>rbind</code> to recombine the data frames. Update <code>get_fruit_prices</code> in
<code>extract_prices.R</code>, source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="best-practices-for-writing-r-scripts.html#cb280-1" tabindex="-1"></a>get_fruit_prices <span class="ot">=</span> <span class="cf">function</span>(sheet, col_names) {</span>
<span id="cb280-2"><a href="best-practices-for-writing-r-scripts.html#cb280-2" tabindex="-1"></a>  <span class="co"># Get all rows from first entry to last entry in column 2.</span></span>
<span id="cb280-3"><a href="best-practices-for-writing-r-scripts.html#cb280-3" tabindex="-1"></a>  is_filled <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(sheet[, <span class="dv">2</span>])</span>
<span id="cb280-4"><a href="best-practices-for-writing-r-scripts.html#cb280-4" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">range</span>(<span class="fu">which</span>(is_filled))</span>
<span id="cb280-5"><a href="best-practices-for-writing-r-scripts.html#cb280-5" tabindex="-1"></a>  prices <span class="ot">=</span> sheet[<span class="fu">seq</span>(idx[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">2</span>, idx[<span class="dv">2</span>]), ]</span>
<span id="cb280-6"><a href="best-practices-for-writing-r-scripts.html#cb280-6" tabindex="-1"></a></span>
<span id="cb280-7"><a href="best-practices-for-writing-r-scripts.html#cb280-7" tabindex="-1"></a>  <span class="co"># Set column names.</span></span>
<span id="cb280-8"><a href="best-practices-for-writing-r-scripts.html#cb280-8" tabindex="-1"></a>  <span class="fu">names</span>(prices) <span class="ot">=</span> col_names</span>
<span id="cb280-9"><a href="best-practices-for-writing-r-scripts.html#cb280-9" tabindex="-1"></a></span>
<span id="cb280-10"><a href="best-practices-for-writing-r-scripts.html#cb280-10" tabindex="-1"></a>  <span class="co"># Compute form subgroups.</span></span>
<span id="cb280-11"><a href="best-practices-for-writing-r-scripts.html#cb280-11" tabindex="-1"></a>  subgroups <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="fu">is.na</span>(prices[, <span class="dv">2</span>]))</span>
<span id="cb280-12"><a href="best-practices-for-writing-r-scripts.html#cb280-12" tabindex="-1"></a>  by_subgroup <span class="ot">=</span> <span class="fu">split</span>(prices, subgroups)</span>
<span id="cb280-13"><a href="best-practices-for-writing-r-scripts.html#cb280-13" tabindex="-1"></a></span>
<span id="cb280-14"><a href="best-practices-for-writing-r-scripts.html#cb280-14" tabindex="-1"></a>  <span class="co"># Process each subgroup, then combine them into a single data frame.</span></span>
<span id="cb280-15"><a href="best-practices-for-writing-r-scripts.html#cb280-15" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">lapply</span>(by_subgroup, process_price_subgroup)</span>
<span id="cb280-16"><a href="best-practices-for-writing-r-scripts.html#cb280-16" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, result)</span>
<span id="cb280-17"><a href="best-practices-for-writing-r-scripts.html#cb280-17" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## # A tibble: 3 × 7
##   form                        average_retail_price units1 preparation_yield_fa…¹
## * &lt;chr&gt;                       &lt;chr&gt;                &lt;chr&gt;  &lt;chr&gt;                 
## 1 Fresh1                      1.5175920102         per p… 0.9                   
## 2 Canned, packed in juice2    1.7876110202         per p… 1                     
## 3 Canned, packed in syrup or… 1.5716448654999999   per p… 0.65                  
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>It seems like the script now works for single fruits!</p>
</div>
<div id="testing-the-script" class="section level3 hasAnchor" number="3.2.7">
<h3><span class="header-section-number">3.2.7</span> Testing the Script<a href="best-practices-for-writing-r-scripts.html#testing-the-script" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s try a different fruit, peaches, to make
sure the script is sufficiently general. In <code>extract_prices.R</code>, change the file
loaded in <code>main</code>, source the script, and call <code>main</code>:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="best-practices-for-writing-r-scripts.html#cb282-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb282-2"><a href="best-practices-for-writing-r-scripts.html#cb282-2" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;data/fruit/peaches 2016.xlsx&quot;</span>)</span>
<span id="cb282-3"><a href="best-practices-for-writing-r-scripts.html#cb282-3" tabindex="-1"></a></span>
<span id="cb282-4"><a href="best-practices-for-writing-r-scripts.html#cb282-4" tabindex="-1"></a>  fruit <span class="ot">=</span> <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb282-5"><a href="best-practices-for-writing-r-scripts.html#cb282-5" tabindex="-1"></a>  col_names <span class="ot">=</span> <span class="fu">get_column_names</span>(sheet)</span>
<span id="cb282-6"><a href="best-practices-for-writing-r-scripts.html#cb282-6" tabindex="-1"></a></span>
<span id="cb282-7"><a href="best-practices-for-writing-r-scripts.html#cb282-7" tabindex="-1"></a>  <span class="fu">get_fruit_prices</span>(sheet, col_names)</span>
<span id="cb282-8"><a href="best-practices-for-writing-r-scripts.html#cb282-8" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## # A tibble: 4 × 7
##   form                        average_retail_price units1 preparation_yield_fa…¹
## * &lt;chr&gt;                       &lt;chr&gt;                &lt;chr&gt;  &lt;chr&gt;                 
## 1 Fresh1                      1.6779315817         per p… 0.96                  
## 2 Canned, packed in juice2    1.8800453697999999   per p… 1                     
## 3 Canned, packed in syrup or… 1.5862877904999999   per p… 0.65                  
## 4 Canned, frozen              3.1870806846000002   per p… 1                     
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>Uh-oh, the last row is <code>"Canned, frozen"</code>, which doesn’t seem correct. Take a
look at the Excel file for peaches to see what went wrong. The bug is that we
assumed subgroups are always separated by header rows where there’s no price
(like the <code>"Canned"</code> row). In the peaches file, the row with prices for frozen
peaches is not separated this way. Looking at a few more of the files, it seems
like there are only a few subgroups: <code>Canned</code>, <code>Dried</code>, <code>Fresh</code>, <code>Frozen</code>, and
<code>Juice</code>. So let’s change the script to check specifically for these.</p>
<p>You can use stringr’s <code>str_starts</code> function to detect entries in the <code>form</code>
column which start with one of the subgroup names. The second argument to the
function is a regular expression (see Section <a href="string-date-processing.html#regular-expressions">1.4.2</a>), a
string which describes a pattern. You can use the pipe character <code>|</code> in a
regular expression to separate several different options. Update the code for
<code>get_fruit_prices</code> in <code>extract_prices.R</code>, source the file, and call <code>main</code>:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="best-practices-for-writing-r-scripts.html#cb284-1" tabindex="-1"></a>get_fruit_prices <span class="ot">=</span> <span class="cf">function</span>(sheet, col_names) {</span>
<span id="cb284-2"><a href="best-practices-for-writing-r-scripts.html#cb284-2" tabindex="-1"></a>  <span class="co"># Get all rows from first entry to last entry in column 2.</span></span>
<span id="cb284-3"><a href="best-practices-for-writing-r-scripts.html#cb284-3" tabindex="-1"></a>  is_filled <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(sheet[, <span class="dv">2</span>])</span>
<span id="cb284-4"><a href="best-practices-for-writing-r-scripts.html#cb284-4" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">range</span>(<span class="fu">which</span>(is_filled))</span>
<span id="cb284-5"><a href="best-practices-for-writing-r-scripts.html#cb284-5" tabindex="-1"></a>  prices <span class="ot">=</span> sheet[<span class="fu">seq</span>(idx[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">2</span>, idx[<span class="dv">2</span>]), ]</span>
<span id="cb284-6"><a href="best-practices-for-writing-r-scripts.html#cb284-6" tabindex="-1"></a></span>
<span id="cb284-7"><a href="best-practices-for-writing-r-scripts.html#cb284-7" tabindex="-1"></a>  <span class="co"># Set column names.</span></span>
<span id="cb284-8"><a href="best-practices-for-writing-r-scripts.html#cb284-8" tabindex="-1"></a>  <span class="fu">names</span>(prices) <span class="ot">=</span> col_names</span>
<span id="cb284-9"><a href="best-practices-for-writing-r-scripts.html#cb284-9" tabindex="-1"></a></span>
<span id="cb284-10"><a href="best-practices-for-writing-r-scripts.html#cb284-10" tabindex="-1"></a>  <span class="co"># Compute form subgroups.</span></span>
<span id="cb284-11"><a href="best-practices-for-writing-r-scripts.html#cb284-11" tabindex="-1"></a>  subgroup_names <span class="ot">=</span> <span class="st">&quot;Canned|Dried|Fresh|Frozen|Juice&quot;</span></span>
<span id="cb284-12"><a href="best-practices-for-writing-r-scripts.html#cb284-12" tabindex="-1"></a>  subgroups <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="fu">str_starts</span>(prices<span class="sc">$</span>form, subgroup_names))</span>
<span id="cb284-13"><a href="best-practices-for-writing-r-scripts.html#cb284-13" tabindex="-1"></a>  by_subgroup <span class="ot">=</span> <span class="fu">split</span>(prices, subgroups)</span>
<span id="cb284-14"><a href="best-practices-for-writing-r-scripts.html#cb284-14" tabindex="-1"></a></span>
<span id="cb284-15"><a href="best-practices-for-writing-r-scripts.html#cb284-15" tabindex="-1"></a>  <span class="co"># Process each subgroup, then combine them into a single data frame.</span></span>
<span id="cb284-16"><a href="best-practices-for-writing-r-scripts.html#cb284-16" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">lapply</span>(by_subgroup, process_price_subgroup)</span>
<span id="cb284-17"><a href="best-practices-for-writing-r-scripts.html#cb284-17" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, result)</span>
<span id="cb284-18"><a href="best-practices-for-writing-r-scripts.html#cb284-18" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## # A tibble: 4 × 7
##   form                        average_retail_price units1 preparation_yield_fa…¹
## * &lt;chr&gt;                       &lt;chr&gt;                &lt;chr&gt;  &lt;chr&gt;                 
## 1 Fresh1                      1.6779315817         per p… 0.96                  
## 2 Canned, packed in juice2    1.8800453697999999   per p… 1                     
## 3 Canned, packed in syrup or… 1.5862877904999999   per p… 0.65                  
## 4 Frozen                      3.1870806846000002   per p… 1                     
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>This appears to be correct. Test the script on the pears data again as well, to
make sure the changes didn’t introduce other bugs:</p>
<pre><code>## # A tibble: 3 × 7
##   form                        average_retail_price units1 preparation_yield_fa…¹
## * &lt;chr&gt;                       &lt;chr&gt;                &lt;chr&gt;  &lt;chr&gt;                 
## 1 Fresh1                      1.5175920102         per p… 0.9                   
## 2 Canned, packed in juice2    1.7876110202         per p… 1                     
## 3 Canned, packed in syrup or… 1.5716448654999999   per p… 0.65                  
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 3 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;</code></pre>
<p>Some of the columns in the data frame have inappropriate data types. This can
be fixed with just a few lines of code, but since it doesn’t provide any
additional insight into how to write scripts, we won’t do so here. If you want
to know more about how to fix “messy data” problems, read Chapter
<a href="string-date-processing.html#string-date-processing">1</a>.</p>
</div>
<div id="iterating-over-all-fruit" class="section level3 hasAnchor" number="3.2.8">
<h3><span class="header-section-number">3.2.8</span> Iterating Over All Fruit<a href="best-practices-for-writing-r-scripts.html#iterating-over-all-fruit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The final step in extracting the fruit price data is to modify
<code>extract_prices.R</code> to extract the prices of all fruits. This is also a good
time to make several small changes to the script that will make it more
convenient to use.</p>
<p>First, change the name of <code>main</code> to <code>read_price_file</code>, make the path to the
Excel file a parameter called <code>path</code>, and limit the Excel sheet to seven
columns:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="best-practices-for-writing-r-scripts.html#cb287-1" tabindex="-1"></a>read_price_file <span class="ot">=</span> <span class="cf">function</span>(path) {</span>
<span id="cb287-2"><a href="best-practices-for-writing-r-scripts.html#cb287-2" tabindex="-1"></a>  sheet <span class="ot">=</span> <span class="fu">read_excel</span>(path)</span>
<span id="cb287-3"><a href="best-practices-for-writing-r-scripts.html#cb287-3" tabindex="-1"></a>  sheet <span class="ot">=</span> sheet[, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>]</span>
<span id="cb287-4"><a href="best-practices-for-writing-r-scripts.html#cb287-4" tabindex="-1"></a></span>
<span id="cb287-5"><a href="best-practices-for-writing-r-scripts.html#cb287-5" tabindex="-1"></a>  fruit <span class="ot">=</span> <span class="fu">get_fruit_name</span>(sheet)</span>
<span id="cb287-6"><a href="best-practices-for-writing-r-scripts.html#cb287-6" tabindex="-1"></a>  col_names <span class="ot">=</span> <span class="fu">get_column_names</span>(sheet)</span>
<span id="cb287-7"><a href="best-practices-for-writing-r-scripts.html#cb287-7" tabindex="-1"></a></span>
<span id="cb287-8"><a href="best-practices-for-writing-r-scripts.html#cb287-8" tabindex="-1"></a>  prices <span class="ot">=</span> <span class="fu">get_fruit_prices</span>(sheet, col_names)</span>
<span id="cb287-9"><a href="best-practices-for-writing-r-scripts.html#cb287-9" tabindex="-1"></a>  prices<span class="sc">$</span>fruit <span class="ot">=</span> fruit</span>
<span id="cb287-10"><a href="best-practices-for-writing-r-scripts.html#cb287-10" tabindex="-1"></a>  prices</span>
<span id="cb287-11"><a href="best-practices-for-writing-r-scripts.html#cb287-11" tabindex="-1"></a>}</span></code></pre></div>
<p>This change makes it possible to reuse the function for many different fruit
(and vegetable) Excel files.</p>
<p>Next, let’s create a new <code>main</code> function, which will call <code>read_price_file</code> on
all of the Excel files in a user-specified directory. The function should have
two parameters: <code>input_dir</code>, for the path to the directory that contains the
Excel files, and <code>output_path</code>, for a path to an RDS file where the resulting
data frame should be saved. You can use <code>list.files</code> to get a vector of paths
to all files in the input directory, <code>lapply</code> to iterate over the files, and
<code>saveRDS</code> to save the result. Here’s the code to add to <code>extract_prices.R</code>:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="best-practices-for-writing-r-scripts.html#cb288-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb288-2"><a href="best-practices-for-writing-r-scripts.html#cb288-2" tabindex="-1"></a>  <span class="at">input_dir =</span> <span class="st">&quot;data/fruit/&quot;</span>,</span>
<span id="cb288-3"><a href="best-practices-for-writing-r-scripts.html#cb288-3" tabindex="-1"></a>  <span class="at">output_path =</span> <span class="st">&quot;prices.rds&quot;</span></span>
<span id="cb288-4"><a href="best-practices-for-writing-r-scripts.html#cb288-4" tabindex="-1"></a>) {</span>
<span id="cb288-5"><a href="best-practices-for-writing-r-scripts.html#cb288-5" tabindex="-1"></a>  <span class="co"># Get vector of all files in directory.</span></span>
<span id="cb288-6"><a href="best-practices-for-writing-r-scripts.html#cb288-6" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Input directory: &quot;</span>, input_dir)</span>
<span id="cb288-7"><a href="best-practices-for-writing-r-scripts.html#cb288-7" tabindex="-1"></a>  paths <span class="ot">=</span> <span class="fu">list.files</span>(input_dir, <span class="at">pattern =</span> <span class="st">&quot;*.xlsx&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb288-8"><a href="best-practices-for-writing-r-scripts.html#cb288-8" tabindex="-1"></a></span>
<span id="cb288-9"><a href="best-practices-for-writing-r-scripts.html#cb288-9" tabindex="-1"></a>  <span class="co"># Read each file and combine the resulting data frames.</span></span>
<span id="cb288-10"><a href="best-practices-for-writing-r-scripts.html#cb288-10" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">lapply</span>(paths, <span class="cf">function</span>(path) {</span>
<span id="cb288-11"><a href="best-practices-for-writing-r-scripts.html#cb288-11" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Reading: &quot;</span>, path)</span>
<span id="cb288-12"><a href="best-practices-for-writing-r-scripts.html#cb288-12" tabindex="-1"></a>    <span class="fu">read_price_file</span>(path)</span>
<span id="cb288-13"><a href="best-practices-for-writing-r-scripts.html#cb288-13" tabindex="-1"></a>  })</span>
<span id="cb288-14"><a href="best-practices-for-writing-r-scripts.html#cb288-14" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">do.call</span>(rbind, result)</span>
<span id="cb288-15"><a href="best-practices-for-writing-r-scripts.html#cb288-15" tabindex="-1"></a></span>
<span id="cb288-16"><a href="best-practices-for-writing-r-scripts.html#cb288-16" tabindex="-1"></a>  <span class="co"># Save the result to an RDS file.</span></span>
<span id="cb288-17"><a href="best-practices-for-writing-r-scripts.html#cb288-17" tabindex="-1"></a>  <span class="fu">saveRDS</span>(result, output_path)</span>
<span id="cb288-18"><a href="best-practices-for-writing-r-scripts.html#cb288-18" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Wrote:&quot;</span>, output_path)</span>
<span id="cb288-19"><a href="best-practices-for-writing-r-scripts.html#cb288-19" tabindex="-1"></a></span>
<span id="cb288-20"><a href="best-practices-for-writing-r-scripts.html#cb288-20" tabindex="-1"></a>  result</span>
<span id="cb288-21"><a href="best-practices-for-writing-r-scripts.html#cb288-21" tabindex="-1"></a>}</span></code></pre></div>
<p>The code for the function includes several calls to <code>message</code> to print
informational messages. It’s a good idea to include these so that you (or other
users) can verify that the paths to files are correct and can quickly diagnose
any bugs you encounter. You can read more about various ways to print output in
R in Section <a href="best-practices-for-writing-r-scripts.html#printing-output">3.5</a>.</p>
<p>Once again, test that the code works by sourcing the script and calling <code>main</code>:</p>
<pre><code>## # A tibble: 125 × 8
##    form                     average_retail_price units1   preparation_yield_fa…¹
##    &lt;chr&gt;                    &lt;chr&gt;                &lt;chr&gt;    &lt;chr&gt;                 
##  1 Fresh1                   1.6155336441000001   per pou… 0.9                   
##  2 Applesauce2              1.0491006433000001   per pou… 1                     
##  3 Juice, ready to drink3   0.63113252779999995  per pint 1                     
##  4 Frozen4                  0.51046574550000001  per pint 1                     
##  5 Fresh1                   1.5675153914496354   per pou… 0.9                   
##  6 Applesauce2              1.0778249292591484   per pou… 1                     
##  7 Juice, ready to drink3   0.72728771310499396  per pint 1                     
##  8 Frozen4                  0.5378679155367232   per pint 1                     
##  9 Fresh1                   3.0871378169999999   per pou… 0.93                  
## 10 Canned, packed in juice2 1.4742760156000001   per pou… 1                     
## # ℹ 115 more rows
## # ℹ abbreviated name: ¹​preparation_yield_factor
## # ℹ 4 more variables: size_of_a_cup_equivalent &lt;chr&gt;, units2 &lt;chr&gt;,
## #   average_price_per_cup_equivalent &lt;chr&gt;, fruit &lt;chr&gt;</code></pre>
<p>This looks almost perfect. There are still a few minor issues with data types,
and also a small bug (related to frozen juice), but all of these can be fixed
with small changes to the script.</p>
</div>
</div>
<div id="managing-environments" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Managing Environments<a href="best-practices-for-writing-r-scripts.html#managing-environments" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Your <strong>computing environment</strong> is the collection of hardware and software you
use to run code. Code developed for one computing environment will not
necessarily run correctly in another. Scripting languages like R and Python are
designed to work with a wide variety of hardware, so in the context of these
languages, software, especially package versions, are the primary cause of
incompatibility.</p>
<p>Documenting the computing environment your code was designed for is an
important part of making your research (or other work) reproducible. One way to
do this is to maintain documentation that lists the specific packages your code
depends on, with complete version information.</p>
<p>You can get version information about your R environment with the <code>sessionInfo</code>
function:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="best-practices-for-writing-r-scripts.html#cb290-1" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.3.2 (2023-10-31)
## Platform: x86_64-apple-darwin20 (64-bit)
## Running under: macOS Sonoma 14.2.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## time zone: America/Los_Angeles
## tzcode source: internal
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] stringr_1.5.1 readxl_1.4.3 
## 
## loaded via a namespace (and not attached):
##  [1] vctrs_0.6.5      cli_3.6.1        knitr_1.45       rlang_1.1.2     
##  [5] xfun_0.41        stringi_1.8.2    jsonlite_1.8.8   glue_1.6.2      
##  [9] htmltools_0.5.7  sass_0.4.8       fansi_1.0.5      rmarkdown_2.25  
## [13] cellranger_1.1.0 evaluate_0.23    jquerylib_0.1.4  tibble_3.2.1    
## [17] fastmap_1.1.1    yaml_2.3.7       lifecycle_1.0.4  bookdown_0.37   
## [21] compiler_4.3.2   pkgconfig_2.0.3  digest_0.6.33    R6_2.5.1        
## [25] utf8_1.2.4       pillar_1.9.0     magrittr_2.0.3   bslib_0.6.1     
## [29] tools_4.3.2      cachem_1.0.8</code></pre>
<p>Documentation is often neglected, and it’s easy to forget that you updated a
package, so you might prefer a more automated approach to recording your R
environment. The <a href="https://rstudio.github.io/renv/">renv</a> package provides functions to record and recreate
environments. See the package documentation for details about how to use the
package.</p>
</div>
<div id="iteration-strategies" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Iteration Strategies<a href="best-practices-for-writing-r-scripts.html#iteration-strategies" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>R is powerful tool for automating tasks that have repetitive steps. For
example, you can:</p>
<ul>
<li>Apply a transformation to an entire column of data.</li>
<li>Compute distances between all pairs from a set of points.</li>
<li>Read a large collection of files from disk in order to combine and analyze
the data they contain.</li>
<li>Simulate how a system evolves over time from a specific set of starting
parameters.</li>
<li>Scrape data from many pages of a website.</li>
</ul>
<p>You can implement concise, efficient solutions for these kinds of tasks in R by
using <strong>iteration</strong>, which means repeating a computation many times. R provides
four different strategies for writing iterative code:</p>
<ol style="list-style-type: decimal">
<li>Vectorization, where a function is implicitly called on each element of a
vector. See <a href="https://ucdavisdatalab.github.io/workshop_r_basics/data-structures.html#vectorization">this section</a> of DataLab’s R Basics reader for
more details.</li>
<li>Apply functions, where a function is explicitly called on each element of a
vector or array. See <a href="https://ucdavisdatalab.github.io/workshop_r_basics/exploring-data.html#apply-functions">this section</a> of DataLab’s R Basics
reader for more details.</li>
<li>Loops, where an expression is evaluated repeatedly until some condition is
met.</li>
<li>Recursion, where a function calls itself.</li>
</ol>
<p>Vectorization is the most efficient and most concise iteration strategy, but
also the least flexible, because it only works with vectorized functions and
vectors. Apply functions are more flexible—they work with any function and
any data structure with elements—but less efficient and less concise. Loops
and recursion provide the most flexibility but are the least concise. In recent
versions of R, apply functions and loops are similar in terms of efficiency.
Recursion tends to be the least efficient iteration strategy in R.</p>
<p>The rest of this section explains how to write loops and how to choose which
iteration strategy to use. We assume you’re already comfortable with
vectorization and have at least some familiarity with apply functions.</p>
<div id="for-loops" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> For-loops<a href="best-practices-for-writing-r-scripts.html#for-loops" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A <strong>for-loop</strong> evaluates an expression once for each element of a vector or
list. The <code>for</code> keyword creates a for-loop. The syntax is:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="best-practices-for-writing-r-scripts.html#cb292-1" tabindex="-1"></a><span class="cf">for</span> (I <span class="cf">in</span> DATA) {</span>
<span id="cb292-2"><a href="best-practices-for-writing-r-scripts.html#cb292-2" tabindex="-1"></a>  <span class="co"># Your code goes here</span></span>
<span id="cb292-3"><a href="best-practices-for-writing-r-scripts.html#cb292-3" tabindex="-1"></a>}</span></code></pre></div>
<p>The variable <code>I</code> is called an <strong>induction variable</strong>. At the beginning of each
iteration, <code>I</code> is assigned the next element of <code>DATA</code>. The loop iterates once
for each element, unless a keyword instructs R to exit the loop early (more
about this in Section <a href="best-practices-for-writing-r-scripts.html#break-next">3.4.4</a>). As with if-statements and functions,
the curly braces <code>{ }</code> are only required if the body contains multiple lines of
code. Here’s a simple for-loop:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="best-practices-for-writing-r-scripts.html#cb293-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb293-2"><a href="best-practices-for-writing-r-scripts.html#cb293-2" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Hi from iteration  &quot;</span>, i)</span></code></pre></div>
<pre><code>## Hi from iteration  1</code></pre>
<pre><code>## Hi from iteration  2</code></pre>
<pre><code>## Hi from iteration  3</code></pre>
<pre><code>## Hi from iteration  4</code></pre>
<pre><code>## Hi from iteration  5</code></pre>
<pre><code>## Hi from iteration  6</code></pre>
<pre><code>## Hi from iteration  7</code></pre>
<pre><code>## Hi from iteration  8</code></pre>
<pre><code>## Hi from iteration  9</code></pre>
<pre><code>## Hi from iteration  10</code></pre>
<p>When some or all of the iterations in a task depend on results from prior
iterations, loops tend to be the most appropriate iteration strategy. For
instance, loops are a good way to implement time-based simulations or compute
values in recursively defined sequences.</p>
<p>As a concrete example, suppose you want to compute the result of starting from
the value 1 and composing the sine function 100 times:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="best-practices-for-writing-r-scripts.html#cb304-1" tabindex="-1"></a>result <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb304-2"><a href="best-practices-for-writing-r-scripts.html#cb304-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb304-3"><a href="best-practices-for-writing-r-scripts.html#cb304-3" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">sin</span>(result)</span>
<span id="cb304-4"><a href="best-practices-for-writing-r-scripts.html#cb304-4" tabindex="-1"></a>}</span>
<span id="cb304-5"><a href="best-practices-for-writing-r-scripts.html#cb304-5" tabindex="-1"></a></span>
<span id="cb304-6"><a href="best-practices-for-writing-r-scripts.html#cb304-6" tabindex="-1"></a>result</span></code></pre></div>
<pre><code>## [1] 0.1688525</code></pre>
<p>Unlike other iteration strategies, loops don’t return a result automatically.
It’s up to you to use variables to store any results you want to use later. If
you want to save a result from every iteration, you can use a vector or a list
indexed on the iteration number:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="best-practices-for-writing-r-scripts.html#cb306-1" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">100</span></span>
<span id="cb306-2"><a href="best-practices-for-writing-r-scripts.html#cb306-2" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">numeric</span>(n)</span>
<span id="cb306-3"><a href="best-practices-for-writing-r-scripts.html#cb306-3" tabindex="-1"></a>result[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb306-4"><a href="best-practices-for-writing-r-scripts.html#cb306-4" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb306-5"><a href="best-practices-for-writing-r-scripts.html#cb306-5" tabindex="-1"></a>  result[i] <span class="ot">=</span> <span class="fu">sin</span>(result[i <span class="sc">-</span> <span class="dv">1</span>])</span>
<span id="cb306-6"><a href="best-practices-for-writing-r-scripts.html#cb306-6" tabindex="-1"></a>}</span>
<span id="cb306-7"><a href="best-practices-for-writing-r-scripts.html#cb306-7" tabindex="-1"></a></span>
<span id="cb306-8"><a href="best-practices-for-writing-r-scripts.html#cb306-8" tabindex="-1"></a><span class="fu">plot</span>(result)</span></code></pre></div>
<p><img src="03_writing_r_scripts_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Section <a href="best-practices-for-writing-r-scripts.html#saving-multiple-results">3.4.3</a> explains this in more detail.</p>
<p>If the iterations in a task are not dependent, it’s preferable to use
vectorization or apply functions instead of a loop. Vectorization is more
efficient, and apply functions are usually more concise.</p>
<p>In some cases, you can use vectorization to handle a task even if the
iterations are dependent. For example, you can use vectorized exponentiation
and the <code>sum</code> function to compute the sum of the cubes of many numbers:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="best-practices-for-writing-r-scripts.html#cb307-1" tabindex="-1"></a>numbers <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">100</span>, <span class="sc">-</span><span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb307-2"><a href="best-practices-for-writing-r-scripts.html#cb307-2" tabindex="-1"></a><span class="fu">sum</span>(numbers<span class="sc">^</span><span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 1001910</code></pre>
</div>
<div id="while-loops" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> While-loops<a href="best-practices-for-writing-r-scripts.html#while-loops" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A <strong>while-loop</strong> runs a block of code repeatedly as long as some condition is
<code>TRUE</code>. The <code>while</code> keyword creates a while-loop. The syntax is:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="best-practices-for-writing-r-scripts.html#cb309-1" tabindex="-1"></a><span class="cf">while</span> (CONDITION) {</span>
<span id="cb309-2"><a href="best-practices-for-writing-r-scripts.html#cb309-2" tabindex="-1"></a>  <span class="co"># Your code goes here</span></span>
<span id="cb309-3"><a href="best-practices-for-writing-r-scripts.html#cb309-3" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>CONDITION</code> should be a scalar logical value or an expression that returns
one. At the beginning of each iteration, R checks the <code>CONDITION</code> and exits the
loop if it’s <code>FALSE</code>. As always, the curly braces <code>{ }</code> are only required if
the body contains multiple lines of code. Here’s a simple while-loop:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="best-practices-for-writing-r-scripts.html#cb310-1" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb310-2"><a href="best-practices-for-writing-r-scripts.html#cb310-2" tabindex="-1"></a><span class="cf">while</span> (i <span class="sc">&lt;</span> <span class="dv">10</span>) {</span>
<span id="cb310-3"><a href="best-practices-for-writing-r-scripts.html#cb310-3" tabindex="-1"></a>  i <span class="ot">=</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb310-4"><a href="best-practices-for-writing-r-scripts.html#cb310-4" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Hello from iteration &quot;</span>, i)</span>
<span id="cb310-5"><a href="best-practices-for-writing-r-scripts.html#cb310-5" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Hello from iteration 1</code></pre>
<pre><code>## Hello from iteration 2</code></pre>
<pre><code>## Hello from iteration 3</code></pre>
<pre><code>## Hello from iteration 4</code></pre>
<pre><code>## Hello from iteration 5</code></pre>
<pre><code>## Hello from iteration 6</code></pre>
<pre><code>## Hello from iteration 7</code></pre>
<pre><code>## Hello from iteration 8</code></pre>
<pre><code>## Hello from iteration 9</code></pre>
<pre><code>## Hello from iteration 10</code></pre>
<p>Notice that this example does the same thing as the simple for-loop in Section
<a href="best-practices-for-writing-r-scripts.html#for-loops">3.4.1</a>, but requires 5 lines of code instead of 2. While-loops are a
generalization of for-loops, and only do the bare minimum necessary to iterate.
They tend to be most useful when you don’t know how many iterations will be
necessary to complete a task.</p>
<p>As an example, suppose you want to add up the integers in order until the total
is greater than 50:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="best-practices-for-writing-r-scripts.html#cb321-1" tabindex="-1"></a>total <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb321-2"><a href="best-practices-for-writing-r-scripts.html#cb321-2" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb321-3"><a href="best-practices-for-writing-r-scripts.html#cb321-3" tabindex="-1"></a><span class="cf">while</span> (total <span class="sc">&lt;</span> <span class="dv">50</span>) {</span>
<span id="cb321-4"><a href="best-practices-for-writing-r-scripts.html#cb321-4" tabindex="-1"></a>  total <span class="ot">=</span> total <span class="sc">+</span> i</span>
<span id="cb321-5"><a href="best-practices-for-writing-r-scripts.html#cb321-5" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;i is &quot;</span>, i, <span class="st">&quot; total is &quot;</span>, total)</span>
<span id="cb321-6"><a href="best-practices-for-writing-r-scripts.html#cb321-6" tabindex="-1"></a>  i <span class="ot">=</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb321-7"><a href="best-practices-for-writing-r-scripts.html#cb321-7" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## i is 1 total is 1</code></pre>
<pre><code>## i is 2 total is 3</code></pre>
<pre><code>## i is 3 total is 6</code></pre>
<pre><code>## i is 4 total is 10</code></pre>
<pre><code>## i is 5 total is 15</code></pre>
<pre><code>## i is 6 total is 21</code></pre>
<pre><code>## i is 7 total is 28</code></pre>
<pre><code>## i is 8 total is 36</code></pre>
<pre><code>## i is 9 total is 45</code></pre>
<pre><code>## i is 10 total is 55</code></pre>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="best-practices-for-writing-r-scripts.html#cb332-1" tabindex="-1"></a>total</span></code></pre></div>
<pre><code>## [1] 55</code></pre>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="best-practices-for-writing-r-scripts.html#cb334-1" tabindex="-1"></a>i</span></code></pre></div>
<pre><code>## [1] 11</code></pre>
</div>
<div id="saving-multiple-results" class="section level3 hasAnchor" number="3.4.3">
<h3><span class="header-section-number">3.4.3</span> Saving Multiple Results<a href="best-practices-for-writing-r-scripts.html#saving-multiple-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Loops often produce a different result for each iteration. If you want to save
more than one result, there are a few things you must do.</p>
<p>First, set up an index vector. The index vector should usually correspond to
the positions of the elements in the data you want to process. The <code>seq_along</code>
function returns an index vector when passed a vector or list. For instance:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="best-practices-for-writing-r-scripts.html#cb336-1" tabindex="-1"></a>numbers <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">21</span>, <span class="dv">3</span>, <span class="sc">-</span><span class="dv">8</span>, <span class="dv">5</span>)</span>
<span id="cb336-2"><a href="best-practices-for-writing-r-scripts.html#cb336-2" tabindex="-1"></a>index <span class="ot">=</span> <span class="fu">seq_along</span>(numbers)</span></code></pre></div>
<p>The loop will iterate over the index rather than the input, so the induction
variable will track the current iteration number. On the first iteration, the
induction variable will be 1, on the second it will be 2, and so on. Then you
can use the induction variable and indexing to get the input for each
iteration.</p>
<p>Second, set up an empty output vector or list. This should usually also
correspond to the input, or one element longer (the extra element comes from
the initial value). R has several functions for creating vectors:</p>
<ul>
<li><p><code>logical</code>, <code>integer</code>, <code>numeric</code>, <code>complex</code>, and <code>character</code> create an empty
vector with a specific type and length</p></li>
<li><p><code>vector</code> creates an empty vector with a specific type and length</p></li>
<li><p><code>rep</code> creates a vector by repeating elements of some other vector</p></li>
</ul>
<p>Empty vectors are filled with <code>FALSE</code>, <code>0</code>, or <code>""</code>, depending on the type of
the vector. Here are some examples:</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="best-practices-for-writing-r-scripts.html#cb337-1" tabindex="-1"></a><span class="fu">logical</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] FALSE FALSE FALSE</code></pre>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="best-practices-for-writing-r-scripts.html#cb339-1" tabindex="-1"></a><span class="fu">numeric</span>(<span class="dv">4</span>)</span></code></pre></div>
<pre><code>## [1] 0 0 0 0</code></pre>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="best-practices-for-writing-r-scripts.html#cb341-1" tabindex="-1"></a><span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] 1 2 1 2</code></pre>
<p>Let’s create an empty numeric vector congruent to the <code>numbers</code> vector:</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="best-practices-for-writing-r-scripts.html#cb343-1" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">length</span>(numbers)</span>
<span id="cb343-2"><a href="best-practices-for-writing-r-scripts.html#cb343-2" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">numeric</span>(n)</span></code></pre></div>
<p>As with the input, you can use the induction variable and indexing to set the
output for each iteration.</p>
<p>Creating a vector or list in advance to store something, as we’ve just done, is
called <strong>preallocation</strong>. Preallocation is extremely important for efficiency
in loops. Avoid the temptation to use <code>c</code> or <code>append</code> to build up the output
bit by bit in each iteration.</p>
<p>Finally, write the loop, making sure to get the input and set the output. As an
example, this loop adds each element of <code>numbers</code> to a running total and
squares the new running total:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="best-practices-for-writing-r-scripts.html#cb344-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> index) {</span>
<span id="cb344-2"><a href="best-practices-for-writing-r-scripts.html#cb344-2" tabindex="-1"></a>  prev <span class="ot">=</span> <span class="cf">if</span> (i <span class="sc">&gt;</span> <span class="dv">1</span>) result[i <span class="sc">-</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb344-3"><a href="best-practices-for-writing-r-scripts.html#cb344-3" tabindex="-1"></a>  result[i] <span class="ot">=</span> (numbers[i] <span class="sc">+</span> prev)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb344-4"><a href="best-practices-for-writing-r-scripts.html#cb344-4" tabindex="-1"></a>}</span>
<span id="cb344-5"><a href="best-practices-for-writing-r-scripts.html#cb344-5" tabindex="-1"></a>result</span></code></pre></div>
<pre><code>## [1] 1.000000e+00 4.840000e+02 2.371690e+05 5.624534e+10 3.163538e+21</code></pre>
</div>
<div id="break-next" class="section level3 hasAnchor" number="3.4.4">
<h3><span class="header-section-number">3.4.4</span> Break &amp; Next<a href="best-practices-for-writing-r-scripts.html#break-next" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>break</code> keyword causes a loop to immediately exit. It only makes sense to
use <code>break</code> inside of an if-statement.</p>
<p>For example, suppose you want to print each string in a vector, but stop at the
first missing value. You can do this with a for-loop and the <code>break</code> keyword:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="best-practices-for-writing-r-scripts.html#cb346-1" tabindex="-1"></a>my_messages <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Hi&quot;</span>, <span class="st">&quot;Hello&quot;</span>, <span class="cn">NA</span>, <span class="st">&quot;Goodbye&quot;</span>)</span>
<span id="cb346-2"><a href="best-practices-for-writing-r-scripts.html#cb346-2" tabindex="-1"></a></span>
<span id="cb346-3"><a href="best-practices-for-writing-r-scripts.html#cb346-3" tabindex="-1"></a><span class="cf">for</span> (msg <span class="cf">in</span> my_messages) {</span>
<span id="cb346-4"><a href="best-practices-for-writing-r-scripts.html#cb346-4" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(msg))</span>
<span id="cb346-5"><a href="best-practices-for-writing-r-scripts.html#cb346-5" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb346-6"><a href="best-practices-for-writing-r-scripts.html#cb346-6" tabindex="-1"></a></span>
<span id="cb346-7"><a href="best-practices-for-writing-r-scripts.html#cb346-7" tabindex="-1"></a>  <span class="fu">message</span>(msg)</span>
<span id="cb346-8"><a href="best-practices-for-writing-r-scripts.html#cb346-8" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Hi</code></pre>
<pre><code>## Hello</code></pre>
<p>The <code>next</code> keyword causes a loop to immediately go to the next iteration. As
with <code>break</code>, it only makes sense to use <code>next</code> inside of an if-statement.</p>
<p>Let’s modify the previous example so that missing values are skipped, but don’t
cause printing to stop. Here’s the code:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="best-practices-for-writing-r-scripts.html#cb349-1" tabindex="-1"></a><span class="cf">for</span> (msg <span class="cf">in</span> my_messages) {</span>
<span id="cb349-2"><a href="best-practices-for-writing-r-scripts.html#cb349-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(msg))</span>
<span id="cb349-3"><a href="best-practices-for-writing-r-scripts.html#cb349-3" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb349-4"><a href="best-practices-for-writing-r-scripts.html#cb349-4" tabindex="-1"></a></span>
<span id="cb349-5"><a href="best-practices-for-writing-r-scripts.html#cb349-5" tabindex="-1"></a>  <span class="fu">message</span>(msg)</span>
<span id="cb349-6"><a href="best-practices-for-writing-r-scripts.html#cb349-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Hi</code></pre>
<pre><code>## Hello</code></pre>
<pre><code>## Goodbye</code></pre>
<p>These keywords work with both for-loops and while-loops.</p>
</div>
<div id="planning-for-iteration" class="section level3 hasAnchor" number="3.4.5">
<h3><span class="header-section-number">3.4.5</span> Planning for Iteration<a href="best-practices-for-writing-r-scripts.html#planning-for-iteration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At first it may seem difficult to decide if and what kind of iteration to use.
Start by thinking about whether you need to do something over and over. If you
don’t, then you probably don’t need to use iteration. If you do, then try
iteration strategies in this order:</p>
<ol style="list-style-type: decimal">
<li>Vectorization</li>
<li>Apply functions
<ul>
<li>Try an apply function if iterations are independent.</li>
</ul></li>
<li>Loops
<ul>
<li>Try a for-loop if some iterations depend on others.</li>
<li>Try a while-loop if the number of iterations is unknown.</li>
</ul></li>
<li>Recursion (which isn’t covered here)
<ul>
<li>Convenient for naturally recursive tasks (like Fibonacci),
but often there are faster solutions.</li>
</ul></li>
</ol>
<p>Start by writing the code for just one iteration. Make sure that code works;
it’s easy to test code for one iteration.</p>
<p>When you have one iteration working, then try using the code with an iteration
strategy (you will have to make some small changes). If it doesn’t work, try to
figure out which iteration is causing the problem. One way to do this is to use
<code>message</code> to print out information. Then try to write the code for the broken
iteration, get that iteration working, and repeat this whole process.</p>
</div>
<div id="case-study-the-collatz-conjecture" class="section level3 hasAnchor" number="3.4.6">
<h3><span class="header-section-number">3.4.6</span> Case Study: The Collatz Conjecture<a href="best-practices-for-writing-r-scripts.html#case-study-the-collatz-conjecture" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <a href="https://en.wikipedia.org/wiki/Collatz_conjecture">Collatz Conjecture</a> is a conjecture in math that was introduced
in 1937 by Lothar Collatz and remains unproven today, despite being relatively
easy to explain. Here’s a statement of the conjecture:</p>
<blockquote>
<p>Start from any positive integer. If the integer is even, divide by 2. If the
integer is odd, multiply by 3 and add 1.</p>
<p>If the result is not 1, repeat using the result as the new starting value.</p>
<p>The result will always reach 1 eventually, regardless of the starting value.</p>
</blockquote>
<p>The sequences of numbers this process generates are called <strong>Collatz
sequences</strong>. For instance, the Collatz sequence starting from 2 is <code>2, 1</code>. The
Collatz sequence starting from 12 is <code>12, 6, 3, 10, 5, 16, 8, 4, 2, 1</code>.</p>
<p>You can use iteration to compute the Collatz sequence for a given starting
value. Since each number in the sequence depends on the previous one, and since
the length of the sequence varies, a while-loop is the most appropriate
iteration strategy:</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="best-practices-for-writing-r-scripts.html#cb353-1" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb353-2"><a href="best-practices-for-writing-r-scripts.html#cb353-2" tabindex="-1"></a>i <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb353-3"><a href="best-practices-for-writing-r-scripts.html#cb353-3" tabindex="-1"></a><span class="cf">while</span> (n <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb353-4"><a href="best-practices-for-writing-r-scripts.html#cb353-4" tabindex="-1"></a>  i <span class="ot">=</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb353-5"><a href="best-practices-for-writing-r-scripts.html#cb353-5" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb353-6"><a href="best-practices-for-writing-r-scripts.html#cb353-6" tabindex="-1"></a>    n <span class="ot">=</span> n <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb353-7"><a href="best-practices-for-writing-r-scripts.html#cb353-7" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb353-8"><a href="best-practices-for-writing-r-scripts.html#cb353-8" tabindex="-1"></a>    n <span class="ot">=</span> <span class="dv">3</span> <span class="sc">*</span> n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb353-9"><a href="best-practices-for-writing-r-scripts.html#cb353-9" tabindex="-1"></a>  }</span>
<span id="cb353-10"><a href="best-practices-for-writing-r-scripts.html#cb353-10" tabindex="-1"></a>  <span class="fu">message</span>(n, <span class="st">&quot; &quot;</span>, <span class="at">appendLF =</span> <span class="cn">FALSE</span>)</span>
<span id="cb353-11"><a href="best-practices-for-writing-r-scripts.html#cb353-11" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## 16 8 4 2 1</code></pre>
<p>As of 2020, scientists have used computers to check the Collatz sequences for
every number up to approximately <span class="math inline">\(2^{64}\)</span>. For more details about the Collatz
Conjecture, check out <a href="https://www.youtube.com/watch?v=094y1Z2wpJg">this video</a>.</p>
<p>For another example, see Liza Wood’s <a href="https://d-rug.github.io/realworld_functions_iteration/">Real-world Function Writing
Mini-reader</a>.</p>
</div>
</div>
<div id="printing-output" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Printing Output<a href="best-practices-for-writing-r-scripts.html#printing-output" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section introduces several different functions for printing output
and making that output easier to read.</p>
<div id="the-print-function" class="section level3 hasAnchor" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> The <code>print</code> Function<a href="best-practices-for-writing-r-scripts.html#the-print-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>print</code> function prints a <strong>string representation</strong> of an object to the
console. The string representation is usually formatted in a way that exposes
details important to programmers rather than users.</p>
<p>For example, when printing a vector, the function prints the position of the
first element on each line in square brackets <code>[ ]</code>:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="best-practices-for-writing-r-scripts.html#cb355-1" tabindex="-1"></a><span class="fu">print</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span></code></pre></div>
<pre><code>##   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18
##  [19]  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36
##  [37]  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53  54
##  [55]  55  56  57  58  59  60  61  62  63  64  65  66  67  68  69  70  71  72
##  [73]  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90
##  [91]  91  92  93  94  95  96  97  98  99 100</code></pre>
<p>The <code>print</code> function also prints quotes around strings:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="best-practices-for-writing-r-scripts.html#cb357-1" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Hi&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Hi&quot;</code></pre>
<p>These features make the <code>print</code> function ideal for printing information when
you’re trying to understand some code or diagnose a bug. On the other hand,
these features also make <code>print</code> a bad choice for printing output or status
messages for users (including you).</p>
<p>R calls the <code>print</code> function automatically anytime a result is returned at the
prompt. Thus it’s not necessary to call <code>print</code> to print something when you’re
working directly in the console—only from within loops, functions, scripts,
and other code that runs non-interactively.</p>
<p>The <code>print</code> function is an S3 generic (see Section <a href="language-fundamentals.html#s3">6.4</a>), so you if you
create an S3 class, you can define a custom print method for it. For S4
objects, R uses the S4 generic <code>show</code> instead of <code>print</code>.</p>
</div>
<div id="the-message-function" class="section level3 hasAnchor" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> The <code>message</code> Function<a href="best-practices-for-writing-r-scripts.html#the-message-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To print output for users, the <code>message</code> function is the one you should use.
The main reason for this is that the <code>message</code> function is part of R’s
<strong>conditions system</strong> for reporting status information as code runs. This makes
it easier for other code to detect, record, respond to, or suppress the output
(see Section <a href="squashing-bugs-with-rs-debugging-tools.html#the-conditions-system">4.2</a> to learn more about R’s conditions
system).</p>
<p>The <code>message</code> function prints its argument(s) and a newline to the console:</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="best-practices-for-writing-r-scripts.html#cb359-1" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Hello world!&quot;</span>)</span></code></pre></div>
<pre><code>## Hello world!</code></pre>
<p>If an argument isn’t a string, the function automatically and silently attempts
to coerce it to one:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="best-practices-for-writing-r-scripts.html#cb361-1" tabindex="-1"></a><span class="fu">message</span>(<span class="dv">4</span>)</span></code></pre></div>
<pre><code>## 4</code></pre>
<p>Some types of objects can’t be coerced to a string:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="best-practices-for-writing-r-scripts.html#cb363-1" tabindex="-1"></a><span class="fu">message</span>(sqrt)</span></code></pre></div>
<pre><code>## Error in FUN(X[[i]], ...): cannot coerce type &#39;builtin&#39; to vector of type &#39;character&#39;</code></pre>
<p>For objects with multiple elements, the function pastes together the string
representations of the elements with no separators in between:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="best-practices-for-writing-r-scripts.html#cb365-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb365-2"><a href="best-practices-for-writing-r-scripts.html#cb365-2" tabindex="-1"></a><span class="fu">message</span>(x)</span></code></pre></div>
<pre><code>## 123</code></pre>
<p>Similarly, if you pass the <code>message</code> function multiple arguments, it pastes
them together with no separators:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="best-practices-for-writing-r-scripts.html#cb367-1" tabindex="-1"></a>name <span class="ot">=</span> <span class="st">&quot;R&quot;</span></span>
<span id="cb367-2"><a href="best-practices-for-writing-r-scripts.html#cb367-2" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Hi, my name is &quot;</span>, name, <span class="st">&quot; and x is &quot;</span>, x)</span></code></pre></div>
<pre><code>## Hi, my name is R and x is 123</code></pre>
<p>This is a convenient way to print names or descriptions alongside values from
your code without having to call a formatting function like <code>paste</code>.</p>
<p>You can make the message function print something without adding a newline at
the end by setting the argument <code>appendLF = FALSE</code>. The difference can be easy
to miss unless you make several calls to <code>message</code>, so the <code>say_hello</code> function
in this example calls <code>message</code> twice:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="best-practices-for-writing-r-scripts.html#cb369-1" tabindex="-1"></a>say_hello <span class="ot">=</span> <span class="cf">function</span>(appendLF) {</span>
<span id="cb369-2"><a href="best-practices-for-writing-r-scripts.html#cb369-2" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Hello&quot;</span>, <span class="at">appendLF =</span> appendLF)</span>
<span id="cb369-3"><a href="best-practices-for-writing-r-scripts.html#cb369-3" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot; world!&quot;</span>)</span>
<span id="cb369-4"><a href="best-practices-for-writing-r-scripts.html#cb369-4" tabindex="-1"></a>}</span>
<span id="cb369-5"><a href="best-practices-for-writing-r-scripts.html#cb369-5" tabindex="-1"></a></span>
<span id="cb369-6"><a href="best-practices-for-writing-r-scripts.html#cb369-6" tabindex="-1"></a><span class="fu">say_hello</span>(<span class="at">appendLF =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Hello</code></pre>
<pre><code>##  world!</code></pre>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="best-practices-for-writing-r-scripts.html#cb372-1" tabindex="-1"></a><span class="fu">say_hello</span>(<span class="at">appendLF =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Hello world!</code></pre>
<p>Note that RStudio always adds a newline in front of the prompt, so making an
isolated call to <code>message</code> with <code>appendLF = FALSE</code> appears to produce the same
output as with <code>appendLF = TRUE</code>. This is an example of a situation where
RStudio leads you astray: in an ordinary R console, the two are clearly
different.</p>
</div>
<div id="the-cat-function" class="section level3 hasAnchor" number="3.5.3">
<h3><span class="header-section-number">3.5.3</span> The <code>cat</code> Function<a href="best-practices-for-writing-r-scripts.html#the-cat-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>cat</code> function, whose name stands for “concatenate and print,” is a
low-level way to print output to the console or a file. The <code>message</code> function
prints output by calling <code>cat</code>, but <code>cat</code> is not part of R’s conditions system.</p>
<p>The <code>cat</code> function prints its argument(s) to the console. It does not add a
newline at the end:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb374-1"><a href="best-practices-for-writing-r-scripts.html#cb374-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Hello&quot;</span>)</span></code></pre></div>
<pre><code>## Hello</code></pre>
<p>As with <code>message</code>, RStudio hides the fact that there’s no newline if you make
an isolated call to <code>cat</code>.</p>
<p>The <code>cat</code> function coerces its arguments to strings and concatenates them. By
default, a space <code></code> is inserted between arguments and their elements:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb376-1"><a href="best-practices-for-writing-r-scripts.html#cb376-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="dv">4</span>)</span></code></pre></div>
<pre><code>## 4</code></pre>
<div class="sourceCode" id="cb378"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb378-1"><a href="best-practices-for-writing-r-scripts.html#cb378-1" tabindex="-1"></a><span class="fu">cat</span>(x)</span></code></pre></div>
<pre><code>## 1 2 3</code></pre>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb380-1"><a href="best-practices-for-writing-r-scripts.html#cb380-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Hello&quot;</span>, <span class="st">&quot;Nick&quot;</span>)</span></code></pre></div>
<pre><code>## Hello Nick</code></pre>
<p>You can set the <code>sep</code> parameter to control the separator <code>cat</code> inserts:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb382-1"><a href="best-practices-for-writing-r-scripts.html#cb382-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Hello&quot;</span>, <span class="st">&quot;world&quot;</span>, x, <span class="at">sep =</span> <span class="st">&quot;|&quot;</span>)</span></code></pre></div>
<pre><code>## Hello|world|1|2|3</code></pre>
<p>If you want to write output to a file rather than to the console, you can call
<code>cat</code> with the <code>file</code> parameter set. However, it’s preferable to use functions
tailored to writing specific kinds of data, such as <code>writeLines</code> (for text) or
<code>write.table</code> (for tabular data), since they provide additional options to
control the output.</p>
<p>Many scripts and packages still use <code>cat</code> to print output, but the <code>message</code>
function provides more flexibility and control to people running the code. Thus
it’s generally preferable to use <code>message</code> in new code. Nevertheless, there are
a few specific cases where <code>cat</code> is useful—for example, if you want to pipe
data to a UNIX shell command. See <code>?cat</code> for details.</p>
</div>
<div id="formatting-output" class="section level3 hasAnchor" number="3.5.4">
<h3><span class="header-section-number">3.5.4</span> Formatting Output<a href="best-practices-for-writing-r-scripts.html#formatting-output" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>R provides a variety of ways to format data before you print it. Taking the
time to format output carefully makes it easier to read and understand, as well
as making your scripts seem more professional.</p>
<div id="escape-sequences-2" class="section level4 hasAnchor" number="3.5.4.1">
<h4><span class="header-section-number">3.5.4.1</span> Escape Sequences<a href="best-practices-for-writing-r-scripts.html#escape-sequences-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One way to format strings is by adding (or removing) <strong>escape sequences</strong>. An
escape sequence is a sequence of characters that represents some other
character, usually one that’s invisible (such as whitespace) or doesn’t appear
on a standard keyboard.</p>
<p>In R, escape sequences always begin with a backslash. For example, <code>\n</code> is a
newline. The <code>message</code> and <code>cat</code> functions automatically convert escape
sequences to the characters they represent:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="best-practices-for-writing-r-scripts.html#cb384-1" tabindex="-1"></a>x <span class="ot">=</span> <span class="st">&quot;Hello</span><span class="sc">\n</span><span class="st">world!&quot;</span></span>
<span id="cb384-2"><a href="best-practices-for-writing-r-scripts.html#cb384-2" tabindex="-1"></a><span class="fu">message</span>(x)</span></code></pre></div>
<pre><code>## Hello
## world!</code></pre>
<p>The <code>print</code> function doesn’t convert escape sequences:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="best-practices-for-writing-r-scripts.html#cb386-1" tabindex="-1"></a><span class="fu">print</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;Hello\nworld!&quot;</code></pre>
<p>Some escape sequences trigger special behavior in the console. For example,
ending a line with a carriage return <code>\r</code> makes the console print the next line
over the line. Try running this code in a console (it’s not possible to see the
result in a static book):</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="best-practices-for-writing-r-scripts.html#cb388-1" tabindex="-1"></a><span class="co"># Run this in an R console.</span></span>
<span id="cb388-2"><a href="best-practices-for-writing-r-scripts.html#cb388-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb388-3"><a href="best-practices-for-writing-r-scripts.html#cb388-3" tabindex="-1"></a>  <span class="fu">message</span>(i, <span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>, <span class="at">appendLF =</span> <span class="cn">FALSE</span>)</span>
<span id="cb388-4"><a href="best-practices-for-writing-r-scripts.html#cb388-4" tabindex="-1"></a>  <span class="co"># Wait 0.5 seconds.</span></span>
<span id="cb388-5"><a href="best-practices-for-writing-r-scripts.html#cb388-5" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb388-6"><a href="best-practices-for-writing-r-scripts.html#cb388-6" tabindex="-1"></a>}</span></code></pre></div>
<p>You can find a complete list of escape sequences in <code>?Quotes</code>.</p>
</div>
<div id="formatting-functions" class="section level4 hasAnchor" number="3.5.4.2">
<h4><span class="header-section-number">3.5.4.2</span> Formatting Functions<a href="best-practices-for-writing-r-scripts.html#formatting-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>You can use the <code>sprintf</code> function to apply specific formatting to values and
substitute them into strings. The function uses a mini-language to describe the
formatting and substitutions. The <code>sprintf</code> function (or something like it) is
available in many programming languages, so being familiar with it will serve
you well on your programming journey.</p>
<p>The key idea is that substitutions are marked by a percent sign <code>%</code> and a
character. The character indicates the kind of data to be substituted: <code>s</code> for
strings, <code>i</code> for integers, <code>f</code> for floating point numbers, and so on.</p>
<p>The first argument to <code>sprintf</code> must be a string, and subsequent arguments are
values to substitute into the string (from left to right). For example:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb389-1"><a href="best-practices-for-writing-r-scripts.html#cb389-1" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">&quot;My age is %i, and my name is %s&quot;</span>, <span class="dv">32</span>, <span class="st">&quot;Nick&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;My age is 32, and my name is Nick&quot;</code></pre>
<p>You can use the mini-language to do things like specify how many digits to
print after a decimal point. Format settings for a substituted value go between
the percent sign <code>%</code> and the character. For instance, here’s how to print <code>pi</code>
with 2 digits after the decimal:</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb391-1"><a href="best-practices-for-writing-r-scripts.html#cb391-1" tabindex="-1"></a><span class="fu">sprintf</span>(<span class="st">&quot;%.2f&quot;</span>, pi)</span></code></pre></div>
<pre><code>## [1] &quot;3.14&quot;</code></pre>
<p>You can learn more by reading <code>?sprintf</code>.</p>
<p>Much simpler are the <code>paste</code> and <code>paste0</code> functions, which coerce their
arguments to strings and concatenate (or “paste together”) them. The <code>paste</code>
function inserts a space <code></code> between each argument, while the <code>paste0</code>
function doesn’t:</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb393-1"><a href="best-practices-for-writing-r-scripts.html#cb393-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Hello&quot;</span>, <span class="st">&quot;world&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Hello world&quot;</code></pre>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb395-1"><a href="best-practices-for-writing-r-scripts.html#cb395-1" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">&quot;Hello&quot;</span>,  <span class="st">&quot;world&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Helloworld&quot;</code></pre>
<p>You can control the character inserted between arguments with the <code>sep</code>
parameter.</p>
<p>By setting an argument for the <code>collapse</code> parameter, you can also use the
<code>paste</code> and <code>paste0</code> functions to concatenate the elements of a vector. The
argument to <code>collapse</code> is inserted between the elements. For example, suppose
you want to paste together elements of a vector inserting a comma and space
<code>,</code> in between:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb397-1"><a href="best-practices-for-writing-r-scripts.html#cb397-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;1, 2, 3&quot;</code></pre>
<p>Members of the R community have developed many packages to make formatting
strings easier:</p>
<ul>
<li><a href="https://cli.r-lib.org/">cli</a> – helper functions for developing command-line interfaces,
including functions to add color, progress bars, and more.</li>
<li><a href="https://glue.tidyverse.org/">glue</a> – alternatives to <code>sprintf</code> for string iterpolation.</li>
<li><a href="https://stringr.tidyverse.org/">stringr</a> – a collection of general-purpose string manipulation functions.</li>
</ul>
</div>
</div>
<div id="logging-output" class="section level3 hasAnchor" number="3.5.5">
<h3><span class="header-section-number">3.5.5</span> Logging Output<a href="best-practices-for-writing-r-scripts.html#logging-output" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Logging</strong> means saving the output from some code to a file as the code runs.
The file where the output is saved is called a <strong>log file</strong> or log, but this
name isn’t indicative of a specific format (unlike, say, a “CSV file”).</p>
<p>It’s a good idea to set up some kind of logging for any code that takes more
than a few minutes to run, because then if something goes wrong you can inspect
the log to diagnose the problem. Think of any output that’s not logged as
ephemeral: it could disappear if someone reboots the computer, or there’s a
power outage, or some other, unforeseen event.</p>
<p>R’s built-in tools for logging are rudimentary, but members of the community
have developed a variety of packages for logging. Here are a few that are still
actively maintained as of January 2023:</p>
<ul>
<li><a href="https://github.com/daroczig/logger">logger</a> – a relatively new package that aims to improve aspects of other
logging packages that R users find confusing.</li>
<li><a href="https://github.com/zatonovo/futile.logger">futile.logger</a> – a popular, mature logging package based on Apache’s
Log4j utility and on R idioms.</li>
<li><a href="https://github.com/WLOGSolutions/r-logging">logging</a> – a mature logging package based on Python’s <code>logging</code> module.</li>
<li><a href="https://github.com/ryapric/loggit">loggit</a> – integrates with R’s conditions system and writes logs in
JavaScript Object Notation (JSON) format so they are easy to inspect
programmatically.</li>
<li><a href="https://github.com/johnmyleswhite/log4r">log4r</a> – another package based on Log4j with an object-oriented
programming approach.</li>
</ul>
</div>
</div>
<div id="reading-input" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Reading Input<a href="best-practices-for-writing-r-scripts.html#reading-input" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section explains how to make R read inputs from the command line,
configuration files, and interactive prompts. These kinds of inputs are often
important for scripts, because they allow for flexibility in initial parameters
and how run-time events are handled.</p>
<div id="command-line-arguments" class="section level3 hasAnchor" number="3.6.1">
<h3><span class="header-section-number">3.6.1</span> Command Line Arguments<a href="best-practices-for-writing-r-scripts.html#command-line-arguments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When you run an R script from the command line, you can optionally pass
additional arguments to the script by putting them after command. Command line
arguments are a convenient and relatively safe way to set parameters in
scripts. This is in contrast to editing scripts directly, which may be
difficult (if the code is complex or disorganized) and may introduce bugs. That
said, for scripts with lots of parameters, we recommend reading the parameters
from a configuration file (see Section <a href="best-practices-for-writing-r-scripts.html#configuration-files">3.6.2</a>) instead or
in addition to command line arguments.</p>
<p>You can capture command line arguments with R’s built-in the <code>commandArgs</code>
function or with functions from a variety of packages. By default, the
<code>commandArgs</code> function returns the entire command used to run R, including the
<code>Rscript</code> command and the name of the script. You can get just the arguments
after the name of the script by setting <code>trailingOnly = TRUE</code>. The function
assumes arguments are space-separated and returns a character vector with one
element for each argument. As an example, set up a script called
<code>hello_name.R</code>:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb399-1"><a href="best-practices-for-writing-r-scripts.html#cb399-1" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb399-2"><a href="best-practices-for-writing-r-scripts.html#cb399-2" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb399-3"><a href="best-practices-for-writing-r-scripts.html#cb399-3" tabindex="-1"></a>) {</span>
<span id="cb399-4"><a href="best-practices-for-writing-r-scripts.html#cb399-4" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(args) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb399-5"><a href="best-practices-for-writing-r-scripts.html#cb399-5" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Usage: Rscript hello_name.R NAME&quot;</span>)</span>
<span id="cb399-6"><a href="best-practices-for-writing-r-scripts.html#cb399-6" tabindex="-1"></a></span>
<span id="cb399-7"><a href="best-practices-for-writing-r-scripts.html#cb399-7" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Hello, &quot;</span>, args[[<span class="dv">1</span>]], <span class="st">&quot;!&quot;</span>)</span>
<span id="cb399-8"><a href="best-practices-for-writing-r-scripts.html#cb399-8" tabindex="-1"></a>}</span>
<span id="cb399-9"><a href="best-practices-for-writing-r-scripts.html#cb399-9" tabindex="-1"></a></span>
<span id="cb399-10"><a href="best-practices-for-writing-r-scripts.html#cb399-10" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<p>Try running the script from the command line with this command:</p>
<pre><code>Rscript hello_name.R Susan</code></pre>
<pre><code>## Hello, Susan!</code></pre>
<p>Several packages on <a href="https://cran.r-project.org/">CRAN</a> provide functions for more complex processing of
command line arguments. As of 2024, many of these packages appear to be
unmaintained or have undesirable dependencies (for example, the <a href="https://github.com/trevorld/r-argparse">argparse</a>
package depends on Python). One of the more promising packages is <a href="https://github.com/trevorld/r-optparse">optparse</a>.</p>
</div>
<div id="configuration-files" class="section level3 hasAnchor" number="3.6.2">
<h3><span class="header-section-number">3.6.2</span> Configuration Files<a href="best-practices-for-writing-r-scripts.html#configuration-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When a script has lots of parameters, reading them from a separate
configuration file is often a good idea. Configuration files are beneficial
because they provide a record of parameter settings that can be saved
separately from the code (with command line arguments, it’s easy to forget
which settings you used in earlier runs).</p>
<p>There are many different formats available for configuration files. Two that
are especially popular are:</p>
<ul>
<li><p><strong>Yet Another Markup Language</strong> (YAML) – YAML is a plain text format
designed to be easy for people to read. It’s widely used in the R community.
For instance, R Markdown notebooks typically include a YAML header for
settings. The <a href="https://github.com/vubiostat/r-yaml/">yaml</a> package provides functions to read and write
YAML files.</p></li>
<li><p><strong>Tom’s Obvious Markup Language</strong> (TOML) – TOML is also a plain text format
designed to be easy for people to read. Compared to YAML, TOML’s main
advantage is that its syntax is simpler and thus easier to learn. TOML is
widely used in other programming communities (especially Python and Rust),
but is not yet widely used in the R community. The <a href="https://github.com/eddelbuettel/rcpptoml">RcppTOML</a> package
provides functions to read TOML files.</p></li>
</ul>
</div>
<div id="prompts" class="section level3 hasAnchor" number="3.6.3">
<h3><span class="header-section-number">3.6.3</span> Prompts<a href="best-practices-for-writing-r-scripts.html#prompts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes it’s useful to prompt the user for input while code is running. For
instance, a script that produces output can prompt the user about what to do if
the output would overwrite an existing file. You can also use prompts to
develop interactive programs, which may be more accessible to users unfamiliar
with programming and command line interfaces.</p>
<p>One way to prompt the user for input is with R’s built-in <code>readline</code> function.
The function prompts the user for input and returns whatever they enter as a
string. Try out the <code>readline</code> function in an R prompt:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb402-1"><a href="best-practices-for-writing-r-scripts.html#cb402-1" tabindex="-1"></a><span class="fu">readline</span>()</span></code></pre></div>
<p>A more sophisticated way to prompt the user for input is with R’s built-in
<code>scan</code> function. The <code>scan</code> function attempts to read a specific type of data,
which you can customize. By default, the function prompts the user for numbers
and returns when they enter a blank line. The result is a vector with one
element for each number they entered. Try out the <code>scan</code> function in an R
prompt:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="best-practices-for-writing-r-scripts.html#cb403-1" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">scan</span>()</span></code></pre></div>
<p>You can set the <code>what</code> parameter in <code>scan</code> to specify the type of data to read.
For instance, if you want to read strings (into a character vector), set <code>what = character()</code>:</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="best-practices-for-writing-r-scripts.html#cb404-1" tabindex="-1"></a><span class="fu">scan</span>(<span class="at">what =</span> <span class="fu">character</span>())</span></code></pre></div>
<p>The <code>scan</code> function has many other parameters, which you can use to control
things like how many values the user can enter and which values should be
interpreted as the missing value <code>NA</code>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidy-relational-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="squashing-bugs-with-rs-debugging-tools.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ucdavisdatalab/workshop_intermediate_r/edit/master/03_writing_r_scripts.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/ucdavisdatalab/workshop_intermediate_r/blob/master/03_writing_r_scripts.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
